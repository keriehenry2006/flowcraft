<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowCraft - Project Manager</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://*.supabase.co https://api.resend.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta name="csrf-token" content=""><!-- CSRF token will be set by JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Resend API Configuration
        window.FLOWCRAFT_RESEND_API_KEY = 're_jBEa4feF_Nvz6ETCQX397aUm2kjSDbmoc';
        window.FLOWCRAFT_FROM_EMAIL = 'noreply@flowcraft.bronskipatryk.pl';
        window.FLOWCRAFT_FROM_NAME = 'FlowCraft';
    </script>
    <script src="config.js"></script>
    <script src="flowcraft-error-handler.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* FlowCraft 2025 Futuristic Palette */
            --flowcraft-primary: #00D4FF;
            --flowcraft-primary-dark: #0099CC;
            --flowcraft-secondary: #FF006E;
            --flowcraft-secondary-dark: #CC0055;
            --flowcraft-accent: #8B5CF6;
            --flowcraft-success: #39FF14;
            --flowcraft-danger: #FF006E;
            --flowcraft-warning: #FFBE0B;
            --flowcraft-dark: #0A0A0F;
            --flowcraft-grey: #6B7280;
            --flowcraft-light-grey: #1A1A2E;
            --flowcraft-white: #FFFFFF;
            --flowcraft-bg: #0A0A0F;
            
            /* 2025 Design Variables */
            --fc-dark-primary: #0A0A0F;
            --fc-dark-secondary: #1A1A2E;
            --fc-dark-accent: #16213E;
            --fc-neon-primary: #00D4FF;
            --fc-neon-secondary: #FF006E;
            --fc-neon-accent: #8B5CF6;
            --fc-neon-warning: #FFBE0B;
            --fc-neon-success: #39FF14;
            --fc-text-primary: #FFFFFF;
            --fc-text-secondary: #B4B4B8;
            --fc-text-muted: #6B7280;
            --fc-surface: rgba(26, 26, 46, 0.8);
            --fc-surface-light: rgba(255, 255, 255, 0.1);
            --fc-border: rgba(0, 212, 255, 0.3);
            
            /* Gradient Variables */
            --flowcraft-gradient-primary: linear-gradient(135deg, #00D4FF 0%, #8B5CF6 100%);
            --flowcraft-gradient-secondary: linear-gradient(135deg, #FF006E 0%, #8B5CF6 100%);
            --flowcraft-gradient-accent: linear-gradient(135deg, #8B5CF6 0%, #00D4FF 100%);
            --flowcraft-gradient-bg: linear-gradient(135deg, #0A0A0F 0%, #1A1A2E 25%, #16213E 75%, #0A0A0F 100%);
            
            /* Shadow Variables - 2025 Neon Effects */
            --flowcraft-shadow-sm: 0 0 10px rgba(0, 212, 255, 0.1);
            --flowcraft-shadow-md: 0 0 20px rgba(0, 212, 255, 0.2), 0 4px 6px rgba(0, 0, 0, 0.3);
            --flowcraft-shadow-lg: 0 0 30px rgba(0, 212, 255, 0.3), 0 10px 15px rgba(0, 0, 0, 0.4);
            --flowcraft-shadow-xl: 0 0 40px rgba(0, 212, 255, 0.4), 0 20px 25px rgba(0, 0, 0, 0.5);
            
            /* Advanced 2025 Effects */
            --fc-glow-primary: 0 0 20px rgba(0, 212, 255, 0.5);
            --fc-glow-secondary: 0 0 30px rgba(255, 0, 110, 0.3);
            --fc-shadow-brutal: 8px 8px 0px rgba(0, 212, 255, 0.2);
            --fc-shadow-deep: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            
            /* Legacy compatibility variables */
            --primary: var(--fc-neon-primary);
            --primary-dark: var(--flowcraft-primary-dark);
            --secondary: var(--fc-text-muted);
            --accent: var(--fc-neon-accent);
            --success: var(--fc-neon-success);
            --danger: var(--fc-neon-secondary);
            --warning: var(--fc-neon-warning);
            --background: var(--fc-dark-primary);
            --surface: var(--fc-surface);
            --border: var(--fc-border);
            --text: var(--fc-text-primary);
            --text-muted: var(--fc-text-muted);
            --shadow: var(--fc-shadow-deep);
            --radius: 0; /* Brutalist */
        }

        body {
            font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            background: var(--flowcraft-gradient-bg);
            min-height: 100vh;
            color: var(--text);
            position: relative;
            overflow-x: hidden;
        }





        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Screens - FlowCraft 2025 Design */
        .auth-container {
            position: relative;
            min-height: 100vh;
            background: var(--fc-dark-primary);
            overflow-x: hidden;
        }

        /* Simple Grid Background like test_integration.html */
        .auth-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 1;
        }

        /* Animated Particles */
        .auth-particles {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 2;
        }

        .auth-particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--fc-neon-primary);
            border-radius: 50%;
            animation: authParticleFloat 6s infinite linear;
            opacity: 0.6;
        }

        @keyframes authParticleFloat {
            0% { transform: translateY(100vh) translateX(0px); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-10px) translateX(50px); opacity: 0; }
        }

        .auth-container-inner {
            position: relative;
            z-index: 3;
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: center;
            gap: 60px;
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header Section - Asymmetric */
        .auth-header-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding: 0 20px;
        }

        .auth-logo-container {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 50px;
            padding: 20px 0;
            position: relative;
        }

        .auth-logo-container::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--fc-neon-primary), var(--fc-neon-secondary));
            box-shadow: var(--fc-glow-primary);
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            box-shadow: var(--fc-glow-primary);
            filter: drop-shadow(0 0 15px rgba(0, 212, 255, 0.6));
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
        }

        .auth-logo:hover {
            filter: drop-shadow(0 0 25px rgba(0, 212, 255, 0.9)) drop-shadow(0 0 50px rgba(255, 0, 110, 0.4));
            box-shadow: var(--fc-glow-primary), var(--fc-glow-secondary);
            transform: scale(1.05);
        }

        .auth-brand-name {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .auth-tagline {
            font-size: 16px;
            color: var(--fc-text-secondary);
            font-weight: 400;
            letter-spacing: 1px;
        }

        .auth-hero-content {
            max-width: 500px;
        }

        .auth-hero-title {
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 50%, var(--fc-neon-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 24px;
            line-height: 0.9;
            text-transform: uppercase;
            letter-spacing: -2px;
        }

        .auth-hero-subtitle {
            font-size: 20px;
            color: var(--fc-text-secondary);
            margin-bottom: 40px;
            line-height: 1.6;
            font-weight: 300;
        }

        .auth-features-brutal {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-feature-brutal {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 0;
            border-left: 3px solid var(--fc-neon-primary);
            padding-left: 20px;
            position: relative;
        }

        .auth-feature-brutal::before {
            content: '▶';
            color: var(--fc-neon-primary);
            font-size: 12px;
            position: absolute;
            left: 8px;
            animation: authPulse 2s infinite;
        }

        @keyframes authPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .auth-feature-brutal span {
            color: var(--fc-text-primary);
            font-weight: 500;
            font-size: 16px;
        }

        /* Auth Card Section */
        .auth-card-section {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
        }

        .auth-card {
            background: var(--fc-surface);
            backdrop-filter: blur(20px);
            border: 2px solid var(--fc-border);
            border-radius: 0; /* Brutalist - no rounded corners */
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--fc-shadow-brutal), var(--fc-shadow-deep);
            position: relative;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .auth-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--fc-glow-primary), var(--fc-shadow-deep);
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--fc-neon-primary), var(--fc-neon-secondary), var(--fc-neon-accent));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .auth-card:hover::before {
            opacity: 0.2;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .auth-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--fc-text-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .auth-header p {
            font-size: 14px;
            color: var(--fc-text-muted);
            font-weight: 300;
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--fc-text-secondary);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .form-group input {
            width: 100%;
            padding: 16px 20px;
            background: var(--fc-dark-secondary);
            border: 2px solid var(--fc-border);
            color: var(--fc-text-primary);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            outline: none;
            border-radius: 0; /* Brutalist */
        }

        .form-group input:focus {
            border-color: var(--fc-neon-primary);
            box-shadow: var(--fc-glow-primary);
            background: var(--fc-dark-accent);
        }

        .form-group input::placeholder {
            color: var(--fc-text-muted);
            font-style: italic;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            gap: 8px;
        }

        .btn-primary {
            width: 100%;
            padding: 18px 24px;
            background: linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 100%);
            border: none;
            color: var(--fc-dark-primary);
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border-radius: 0; /* Brutalist */
            box-shadow: var(--fc-shadow-brutal);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 12px 12px 0px rgba(0, 212, 255, 0.3), var(--fc-glow-primary);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            padding: 12px 20px;
            background: var(--fc-dark-secondary);
            border: 2px solid var(--fc-border);
            color: var(--fc-text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-secondary:hover::before {
            left: 100%;
        }

        .btn-secondary:hover {
            background: var(--fc-border);
            color: var(--fc-text-primary);
            border-color: var(--fc-neon-primary);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        .auth-switch {
            text-align: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--fc-border);
            color: var(--fc-text-muted);
            font-size: 14px;
        }

        .auth-switch a {
            color: var(--fc-neon-primary);
            text-decoration: none;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .auth-switch a:hover {
            color: var(--fc-neon-secondary);
            text-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        /* ============================================
           FLOWCRAFT 2025 UNIFIED BUTTON SYSTEM
           ============================================ */
        
        /* Base FlowCraft Button */
        .btn-fc {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border: 2px solid var(--fc-border);
            border-radius: 0; /* Brutalist */
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            gap: 8px;
            background: var(--fc-dark-secondary);
            color: var(--fc-text-primary);
            position: relative;
            overflow: hidden;
            box-shadow: var(--flowcraft-shadow-sm);
            user-select: none;
        }

        .btn-fc::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-fc:hover::before {
            left: 100%;
        }

        .btn-fc:hover {
            transform: translateY(-2px);
            box-shadow: var(--fc-glow-primary), var(--flowcraft-shadow-lg);
            border-color: var(--fc-neon-primary);
        }

        .btn-fc:active {
            transform: translateY(0);
            box-shadow: var(--flowcraft-shadow-sm);
        }

        .btn-fc:focus {
            outline: none;
            box-shadow: var(--fc-glow-primary), 0 0 0 3px rgba(0, 212, 255, 0.3);
        }

        .btn-fc:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--fc-dark-secondary) !important;
            color: var(--fc-text-muted) !important;
            border-color: var(--fc-border) !important;
            transform: none !important;
            box-shadow: var(--flowcraft-shadow-sm) !important;
        }

        .btn-fc:disabled:hover {
            transform: none !important;
        }

        /* Primary Button - Main Actions */
        .btn-fc.btn-fc-primary {
            background: linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 100%);
            border-color: var(--fc-neon-primary);
            color: var(--fc-dark-primary);
            font-weight: 700;
            box-shadow: var(--fc-shadow-brutal);
        }

        .btn-fc.btn-fc-primary::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }

        .btn-fc.btn-fc-primary:hover {
            transform: translateY(-3px);
            box-shadow: 12px 12px 0px rgba(0, 212, 255, 0.3), var(--fc-glow-primary);
        }

        /* Secondary Button - Supporting Actions */
        .btn-fc.btn-fc-secondary {
            background: var(--fc-dark-secondary);
            border-color: var(--fc-border);
            color: var(--fc-text-secondary);
        }

        .btn-fc.btn-fc-secondary:hover {
            background: var(--fc-border);
            color: var(--fc-text-primary);
            border-color: var(--fc-neon-primary);
        }

        /* Danger Button - Destructive Actions */
        .btn-fc.btn-fc-danger {
            background: linear-gradient(135deg, var(--fc-neon-secondary) 0%, #DC2626 100%);
            border-color: var(--fc-neon-secondary);
            color: var(--fc-text-primary);
            box-shadow: 4px 4px 0px rgba(255, 0, 110, 0.3);
        }

        .btn-fc.btn-fc-danger::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .btn-fc.btn-fc-danger:hover {
            transform: translateY(-3px);
            box-shadow: 8px 8px 0px rgba(255, 0, 110, 0.4), var(--fc-glow-secondary);
        }

        /* Success Button - Confirmation Actions */
        .btn-fc.btn-fc-success {
            background: linear-gradient(135deg, var(--fc-neon-success) 0%, #059669 100%);
            border-color: var(--fc-neon-success);
            color: var(--fc-dark-primary);
            box-shadow: 4px 4px 0px rgba(57, 255, 20, 0.3);
        }

        .btn-fc.btn-fc-success::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .btn-fc.btn-fc-success:hover {
            transform: translateY(-3px);
            box-shadow: 8px 8px 0px rgba(57, 255, 20, 0.4), 0 0 20px rgba(57, 255, 20, 0.5);
        }

        /* Warning Button - Caution Actions */
        .btn-fc.btn-fc-warning {
            background: linear-gradient(135deg, var(--fc-neon-warning) 0%, #D97706 100%);
            border-color: var(--fc-neon-warning);
            color: var(--fc-dark-primary);
            box-shadow: 4px 4px 0px rgba(255, 190, 11, 0.3);
        }

        .btn-fc.btn-fc-warning::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .btn-fc.btn-fc-warning:hover {
            transform: translateY(-3px);
            box-shadow: 8px 8px 0px rgba(255, 190, 11, 0.4), 0 0 20px rgba(255, 190, 11, 0.5);
        }

        /* Accent Button - Special Actions */
        .btn-fc.btn-fc-accent {
            background: linear-gradient(135deg, var(--fc-neon-accent) 0%, #7C3AED 100%);
            border-color: var(--fc-neon-accent);
            color: var(--fc-text-primary);
            box-shadow: 4px 4px 0px rgba(139, 92, 246, 0.3);
        }

        .btn-fc.btn-fc-accent::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .btn-fc.btn-fc-accent:hover {
            transform: translateY(-3px);
            box-shadow: 8px 8px 0px rgba(139, 92, 246, 0.4), 0 0 20px rgba(139, 92, 246, 0.5);
        }

        /* Outline Variants */
        .btn-fc.btn-fc-outline {
            background: transparent;
            border-width: 2px;
        }

        .btn-fc.btn-fc-outline.btn-fc-primary {
            background: transparent;
            border-color: var(--fc-neon-primary);
            color: var(--fc-neon-primary);
            box-shadow: none;
        }

        .btn-fc.btn-fc-outline.btn-fc-primary:hover {
            background: var(--fc-neon-primary);
            color: var(--fc-dark-primary);
            box-shadow: var(--fc-glow-primary);
        }

        .btn-fc.btn-fc-outline.btn-fc-danger {
            background: transparent;
            border-color: var(--fc-neon-secondary);
            color: var(--fc-neon-secondary);
            box-shadow: none;
        }

        .btn-fc.btn-fc-outline.btn-fc-danger:hover {
            background: var(--fc-neon-secondary);
            color: var(--fc-text-primary);
            box-shadow: var(--fc-glow-secondary);
        }

        /* Ghost Variants */
        .btn-fc.btn-fc-ghost {
            background: transparent;
            border: 2px solid transparent;
            color: var(--fc-text-secondary);
        }

        .btn-fc.btn-fc-ghost:hover {
            background: var(--fc-surface);
            border-color: var(--fc-border);
            color: var(--fc-text-primary);
        }

        /* Size Variants */
        .btn-fc.btn-fc-sm {
            padding: 8px 16px;
            font-size: 12px;
            gap: 6px;
        }

        .btn-fc.btn-fc-md {
            padding: 12px 20px;
            font-size: 14px;
            gap: 8px;
        }

        .btn-fc.btn-fc-lg {
            padding: 16px 32px;
            font-size: 16px;
            gap: 10px;
            font-weight: 700;
        }

        .btn-fc.btn-fc-xl {
            padding: 20px 40px;
            font-size: 18px;
            gap: 12px;
            font-weight: 700;
        }

        /* Width Variants */
        .btn-fc.btn-fc-full {
            width: 100%;
        }

        .btn-fc.btn-fc-auto {
            width: auto;
        }

        /* Special Utility Classes */
        .btn-fc.btn-fc-loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-fc.btn-fc-loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: btnFcSpin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes btnFcSpin {
            to { transform: rotate(360deg); }
        }

        /* Close Button Variants */
        .btn-fc.btn-fc-close {
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 0, 110, 0.1);
            border-color: var(--fc-neon-secondary);
            color: var(--fc-neon-secondary);
            font-size: 18px;
            font-weight: 700;
            text-transform: none;
            letter-spacing: 0;
        }

        .btn-fc.btn-fc-close:hover {
            background: var(--fc-neon-secondary);
            color: var(--fc-text-primary);
            transform: scale(1.1);
        }

        /* Icon Button Variants */
        .btn-fc.btn-fc-icon {
            padding: 10px;
            width: 44px;
            height: 44px;
        }

        .btn-fc.btn-fc-icon.btn-fc-sm {
            padding: 6px;
            width: 32px;
            height: 32px;
        }

        .btn-fc.btn-fc-icon.btn-fc-lg {
            padding: 14px;
            width: 52px;
            height: 52px;
        }

        /* Group styling for button groups */
        .btn-fc-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-fc-group .btn-fc {
            margin: 0;
        }

        .btn-fc-group.btn-fc-group-attached .btn-fc {
            margin: 0;
            border-radius: 0;
        }

        .btn-fc-group.btn-fc-group-attached .btn-fc:first-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .btn-fc-group.btn-fc-group-attached .btn-fc:last-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .btn-fc-group.btn-fc-group-attached .btn-fc:not(:last-child) {
            border-right-width: 1px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .btn-fc.btn-fc-lg {
                padding: 14px 24px;
                font-size: 15px;
            }
            
            .btn-fc.btn-fc-xl {
                padding: 16px 32px;
                font-size: 16px;
            }
        }

        /* Auth Responsive Design */
        @media (max-width: 1024px) {
            .auth-container-inner {
                grid-template-columns: 1fr;
                gap: 40px;
                text-align: center;
            }

            .auth-card {
                box-shadow: var(--fc-shadow-deep);
            }

            .auth-hero-title {
                font-size: clamp(2.5rem, 6vw, 4rem);
            }
        }

        @media (max-width: 768px) {
            .auth-container-inner {
                padding: 20px;
            }

            .auth-card {
                padding: 32px 24px;
            }

            .auth-hero-content {
                max-width: 100%;
            }
        }

        /* Auth Status Indicator */
        .auth-status-indicator {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--fc-surface);
            padding: 12px 20px;
            border: 1px solid var(--fc-border);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--fc-text-primary);
            z-index: 10;
        }

        .auth-status-dot {
            width: 8px;
            height: 8px;
            background: var(--fc-neon-success);
            border-radius: 50%;
            animation: authStatusPulse 2s infinite;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
        }

        @keyframes authStatusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Auth Loading Bar */
        .auth-loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, var(--fc-neon-primary), var(--fc-neon-secondary));
            z-index: 9999;
            animation: authLoading 2s infinite;
        }

        @keyframes authLoading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100vw); }
        }

        /* Dashboard */
        .dashboard {
            display: none;
            background: var(--background);
            min-height: 100vh;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .logo:hover img {
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.9)) drop-shadow(0 0 40px rgba(255, 0, 110, 0.4)) !important;
            transform: scale(1.08) !important;
        }

        .logo:hover span {
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .logo:active {
            transform: scale(0.98);
        }

        /* Responsive logo adjustments */
        @media (max-width: 768px) {
            .logo img {
                width: 40px !important;
                height: 40px !important;
                margin-right: 12px !important;
            }
            
            .logo span {
                font-size: 20px !important;
            }
            
            .header-content {
                padding: 0 16px;
            }
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            color: var(--text-muted);
        }

        /* Projects Grid */
        .projects-section {
            padding: 40px 0;
        }

        .section-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 32px;
            gap: 20px;
        }

        .section-title {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            margin: 0;
        }

        .new-project-btn {
            padding: 12px 24px;
            background: var(--fc-surface);
            border: 2px solid var(--fc-neon-accent);
            color: var(--fc-text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .new-project-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
            transition: left 0.5s;
        }

        .new-project-btn:hover::before {
            left: 100%;
        }

        .new-project-btn:hover {
            background: var(--fc-neon-accent);
            color: var(--fc-dark-primary);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .project-card {
            background: linear-gradient(135deg, var(--fc-surface) 0%, rgba(0, 212, 255, 0.1) 100%);
            border: 2px solid var(--fc-neon-primary);
            border-radius: 0;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 4px 4px 0px rgba(0, 212, 255, 0.3);
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(255, 0, 110, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .project-card:hover::before {
            opacity: 1;
        }

        .project-card:hover {
            transform: translateY(-4px) translateX(-2px);
            box-shadow: 8px 8px 0px rgba(0, 212, 255, 0.4), 0 0 30px rgba(0, 212, 255, 0.3);
            border-color: var(--fc-neon-secondary);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            position: relative;
            z-index: 2;
        }

        .project-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--fc-text-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
            flex: 1;
        }

        .btn-delete-project {
            background: transparent;
            border: 2px solid var(--fc-neon-secondary);
            color: var(--fc-neon-secondary);
            padding: 6px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            border-radius: 0;
        }

        .btn-delete-project:hover {
            background: var(--fc-neon-secondary);
            color: var(--fc-dark-primary);
            box-shadow: 0 0 8px rgba(255, 0, 110, 0.3);
        }

        .btn-delete-sheet {
            background: transparent;
            border: 1px solid var(--fc-neon-secondary);
            color: var(--fc-neon-secondary);
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            border-radius: 0;
        }

        .btn-delete-sheet:hover {
            background: var(--fc-neon-secondary);
            color: var(--fc-dark-primary);
            box-shadow: 0 0 6px rgba(255, 0, 110, 0.3);
        }

        .project-description {
            color: var(--fc-text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 14px;
            position: relative;
            z-index: 2;
        }

        .project-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: var(--fc-text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 2;
        }

        .project-stats span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Workflows View */
        .sheets-view {
            display: none;
            padding: 40px 0;
        }

        .sheets-view.active {
            display: block;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            font-size: 14px;
            color: var(--fc-text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .breadcrumb a {
            color: var(--fc-neon-primary);
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            padding: 4px 8px;
        }

        .breadcrumb a::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--fc-neon-primary), var(--fc-neon-secondary));
            transition: width 0.3s ease;
        }

        .breadcrumb a:hover::before {
            width: 100%;
        }

        .breadcrumb a:hover {
            color: var(--fc-neon-secondary);
            text-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        .breadcrumb span {
            color: var(--fc-text-muted);
            font-weight: 400;
        }

        .sheets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .sheet-card {
            background: linear-gradient(135deg, var(--fc-surface) 0%, rgba(0, 212, 255, 0.1) 100%);
            border: 2px solid var(--fc-neon-primary);
            border-radius: 0;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 4px 4px 0px rgba(0, 212, 255, 0.3);
        }

        .sheet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(255, 0, 110, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sheet-card:hover::before {
            opacity: 1;
        }

        .sheet-card:hover {
            transform: translateY(-4px) translateX(-2px);
            box-shadow: 8px 8px 0px rgba(0, 212, 255, 0.4), 0 0 30px rgba(0, 212, 255, 0.3);
            border-color: var(--fc-neon-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal Form Styles - FlowCraft 2025 */
        .modal-content {
            background: var(--fc-surface);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 0; /* Brutalist */
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            box-shadow: 4px 4px 0px rgba(0, 212, 255, 0.2);
        }

        .form-group input[type="text"],
        .form-group input[type="email"], 
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 0; /* Brutalist */
            background: rgba(20, 20, 40, 0.85);
            color: #FFFFFF;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="password"]:focus,
        .form-group input[type="number"]:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: rgba(0, 212, 255, 0.6);
            background: rgba(22, 33, 62, 0.9);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: rgba(180, 180, 184, 0.9);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .form-group small {
            color: var(--fc-text-muted);
            font-size: 11px;
            margin-top: 4px;
            display: block;
            font-style: italic;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 0; /* Brutalist */
            color: var(--fc-text-primary);
            font-weight: 600;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 1001;
            transform: translateX(400px);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            border: 2px solid;
            box-shadow: 4px 4px 0px;
            backdrop-filter: blur(10px);
            font-size: 13px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--fc-surface) 0%, rgba(0, 212, 255, 0.2) 100%);
            border-color: var(--fc-neon-primary);
            box-shadow: 4px 4px 0px rgba(0, 212, 255, 0.4);
            color: var(--fc-text-primary);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--fc-surface) 0%, rgba(255, 0, 110, 0.2) 100%);
            border-color: var(--fc-neon-secondary);
            box-shadow: 4px 4px 0px rgba(255, 0, 110, 0.4);
            color: var(--fc-text-primary);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--fc-surface) 0%, rgba(255, 190, 11, 0.2) 100%);
            border-color: var(--fc-neon-warning);
            box-shadow: 4px 4px 0px rgba(255, 190, 11, 0.4);
            color: var(--fc-text-primary);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--fc-surface) 0%, rgba(139, 92, 246, 0.2) 100%);
            border-color: var(--fc-neon-accent);
            box-shadow: 4px 4px 0px rgba(139, 92, 246, 0.4);
            color: var(--fc-text-primary);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utilities */
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 16px; }
        .hidden { display: none !important; }

        /* Custom Fields Management */
        .fields-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .field-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--background);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .field-item input {
            flex: 1;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 6px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Processes Table Styles - FlowCraft 2025 */
        .processes-view {
            display: none;
        }

        .processes-view.active {
            display: block;
        }

        #processes-table-container {
            background: linear-gradient(135deg, var(--fc-dark-secondary) 0%, var(--fc-dark-accent) 100%);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 0; /* Brutalist */
            overflow-x: auto;
            margin-top: 20px;
            box-shadow: 2px 2px 0px rgba(0, 212, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        #processes-table {
            table-layout: fixed;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        #processes-table thead tr {
            background: linear-gradient(135deg, var(--fc-dark-primary) 0%, var(--fc-dark-secondary) 100%);
            border-bottom: 2px solid rgba(0, 212, 255, 0.5);
        }

        #processes-table th {
            padding: 18px 16px;
            text-align: left;
            font-weight: 700;
            color: #FFFFFF;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 13px;
            border-right: 1px solid rgba(0, 212, 255, 0.3);
            background: linear-gradient(135deg, var(--fc-dark-primary) 0%, rgba(0, 212, 255, 0.08) 100%);
            position: relative;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        #processes-table th:last-child {
            border-right: none;
        }

        #processes-table th::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.05) 0%, rgba(255, 0, 110, 0.02) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #processes-table th:hover::before {
            opacity: 1;
        }

        #processes-table th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.6), rgba(255, 0, 110, 0.4));
            box-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
        }

        #processes-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            border-right: 1px solid rgba(0, 212, 255, 0.1);
            vertical-align: middle;
            word-wrap: break-word;
            overflow-wrap: break-word;
            background: rgba(26, 26, 46, 0.3);
        }

        #processes-table td:last-child {
            border-right: none;
        }

        #processes-table tr:hover td {
            background: rgba(0, 212, 255, 0.08);
            box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.1);
        }

        #processes-table tr:nth-child(even) td {
            background: rgba(26, 26, 46, 0.5);
        }

        #processes-table tr:nth-child(even):hover td {
            background: rgba(0, 212, 255, 0.12);
        }

        /* Input Fields - Stonowane ale czytelne */
        .inline-edit {
            background: rgba(20, 20, 40, 0.85);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 0;
            padding: 10px 14px;
            width: 100%;
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
            font-family: inherit;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .inline-edit::placeholder {
            color: rgba(180, 180, 184, 0.7);
            font-style: italic;
            font-weight: 400;
        }

        .inline-edit:focus {
            outline: none;
            border-color: rgba(0, 212, 255, 0.6);
            background: rgba(22, 33, 62, 0.9);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2), inset 0 0 5px rgba(0, 212, 255, 0.05);
            color: #FFFFFF;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }

        .inline-edit:hover {
            border-color: rgba(0, 212, 255, 0.4);
            background: rgba(26, 26, 46, 0.9);
            box-shadow: 0 0 5px rgba(0, 212, 255, 0.1);
        }

        /* Select Dropdowns - Stonowane */
        .inline-edit select,
        select.inline-edit {
            background: rgba(20, 20, 40, 0.85);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 0;
            padding: 10px 14px;
            color: #FFFFFF;
            font-family: inherit;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .inline-edit select:focus,
        select.inline-edit:focus {
            border-color: rgba(0, 212, 255, 0.6);
            background: rgba(22, 33, 62, 0.9);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }

        .inline-edit select option,
        select.inline-edit option {
            background: var(--fc-dark-secondary);
            color: #FFFFFF;
            padding: 10px;
            font-weight: 600;
        }

        .inline-edit select option:hover,
        select.inline-edit option:hover {
            background: rgba(0, 212, 255, 0.2);
            color: #FFFFFF;
        }

        /* Column Management Styles */
        .column-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .column-item input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }

        .column-item input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .column-item .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 60px;
        }

        .column-item.pending-delete {
            background: #ffeaa7;
            border-color: #fdcb6e;
        }

        .column-item.pending-add {
            background: #d1f2eb;
            border-color: #a3e4d7;
        }

        .column-item.pending-rename {
            background: #e8f4f8;
            border-color: #aed6f1;
        }

        .custom-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--fc-border);
            border-radius: 0; /* Brutalist */
            background: rgba(26, 26, 46, 0.8);
            color: var(--fc-text-primary);
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .custom-field:focus {
            outline: none;
            border-color: var(--fc-neon-primary);
            background: var(--fc-dark-accent);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        /* Responsive column widths with auto-fitting */
        #processes-table {
            table-layout: auto;
            width: 100%;
            overflow-x: auto;
        }
        
        /* Sticky table header */
        #processes-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--fc-dark-primary);
        }
        
        #processes-table thead th {
            background: var(--fc-dark-primary);
            border-bottom: 2px solid var(--fc-neon-primary);
        }
        
        #processes-table th:nth-child(1), /* Name */
        #processes-table td:nth-child(1) {
            width: auto;
            min-width: 160px;
            max-width: 200px;
        }

        #processes-table th:nth-child(2), /* Description */
        #processes-table td:nth-child(2) {
            width: auto;
            min-width: 200px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            cursor: help;
        }
        
        /* Description cell specific styling */
        .description-cell {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .description-cell:hover {
            background-color: rgba(0, 212, 255, 0.1);
        }
        
        /* Process type display styling */
        .process-type-display {
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .process-type-display:hover {
            background-color: rgba(0, 212, 255, 0.1);
        }
        
        .type-abbreviation {
            font-weight: bold;
            font-size: 12px;
            color: var(--fc-neon-primary);
            text-align: center;
            min-width: 20px;
            padding: 2px 4px;
            border-radius: 2px;
            background-color: rgba(0, 212, 255, 0.1);
        }
        
        .type-abbreviation:hover {
            background-color: rgba(0, 212, 255, 0.2);
        }
        
        /* Tooltip for description */
        .description-tooltip {
            position: absolute;
            background: var(--fc-dark-primary);
            color: var(--fc-text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--fc-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
            white-space: normal;
            font-size: 12px;
            line-height: 1.4;
            opacity: 0;
            transform: translateY(-5px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }
        
        .description-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .description-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid var(--fc-dark-primary);
        }
        
        /* Dependencies selector styles */
        .dependencies-selector {
            width: 100%;
            padding: 6px 8px;
            background: var(--fc-surface);
            border: 1px solid var(--fc-border);
            border-radius: 0;
            color: var(--fc-text-primary);
            font-size: 12px;
            cursor: pointer;
            text-align: left;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .dependencies-selector:hover {
            background: var(--fc-dark-accent);
            border-color: var(--fc-neon-primary);
        }
        
        /* Dependencies modal */
        .dependencies-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dependencies-modal-content {
            background: var(--fc-dark-primary);
            border: 2px solid var(--fc-border);
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .dependencies-modal h3 {
            color: var(--fc-neon-primary);
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .dependencies-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .dependency-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .dependency-item:last-child {
            border-bottom: none;
        }
        
        .dependency-checkbox {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: var(--fc-neon-primary);
        }
        
        .dependency-label {
            color: var(--fc-text-primary);
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }
        
        .dependencies-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .dependencies-modal-buttons button {
            padding: 8px 16px;
            border: 1px solid var(--fc-border);
            border-radius: 4px;
            background: var(--fc-surface);
            color: var(--fc-text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .dependencies-modal-buttons button:hover {
            background: var(--fc-dark-accent);
            border-color: var(--fc-neon-primary);
        }
        
        .dependencies-modal-buttons .btn-primary {
            background: var(--fc-neon-primary);
            color: var(--fc-dark-primary);
            font-weight: bold;
        }
        
        .dependencies-modal-buttons .btn-primary:hover {
            background: var(--fc-neon-secondary);
        }

        #processes-table th:nth-child(3), /* Working Day */
        #processes-table td:nth-child(3) {
            width: auto;
            min-width: 90px;
            max-width: 110px;
        }

        #processes-table th:nth-child(4), /* Due Time */
        #processes-table td:nth-child(4) {
            width: auto;
            min-width: 110px;
            max-width: 130px;
        }

        #processes-table th:nth-child(5), /* Dependencies */
        #processes-table td:nth-child(5) {
            width: auto;
            min-width: 140px;
            max-width: 200px;
        }

        #processes-table th:nth-child(6), /* Type */
        #processes-table td:nth-child(6) {
            width: auto;
            min-width: 80px;
            max-width: 120px;
        }

        #processes-table th:nth-child(7), /* Status */
        #processes-table td:nth-child(7) {
            width: auto;
            min-width: 120px;
            max-width: 150px;
        }

        #processes-table th:nth-child(8), /* Deadline */
        #processes-table td:nth-child(8) {
            width: auto;
            min-width: 140px;
            max-width: 160px;
        }

        #processes-table th:nth-child(9), /* Assigned To */
        #processes-table td:nth-child(9) {
            width: auto;
            min-width: 120px;
            max-width: 150px;
        }

        #custom-columns-header, /* Custom columns */
        #custom-columns-header th {
            width: 10%;
            min-width: 80px;
        }

        #processes-table th:last-child, /* Actions */
        #processes-table td:last-child {
            width: 100px !important;
            min-width: 100px !important;
        }

        /* Responsive behavior for smaller screens */
        @media (max-width: 1200px) {
            #processes-table th:nth-child(2),
            #processes-table td:nth-child(2) {
                width: 18%;
            }
            
            #custom-columns-header,
            #custom-columns-header th {
                width: 12%;
            }
        }

        @media (max-width: 992px) {
            #processes-table-container {
                overflow-x: auto;
            }
            
            #processes-table {
                min-width: 800px;
            }
        }

        /* Action Buttons - Clean Icons */
        .process-actions {
            display: flex;
            gap: 4px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .btn-edit, .btn-delete {
            padding: 8px;
            border: 1px solid;
            border-radius: 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit {
            background: rgba(20, 20, 40, 0.8);
            border-color: rgba(0, 212, 255, 0.4);
            color: #FFFFFF;
        }

        .btn-edit::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-edit:hover::before {
            left: 100%;
        }

        .btn-edit:hover {
            background: rgba(0, 212, 255, 0.3);
            color: #FFFFFF;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-delete {
            background: rgba(20, 20, 40, 0.8);
            border-color: rgba(255, 0, 110, 0.4);
            color: #FFFFFF;
        }

        .btn-delete::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 0, 110, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-delete:hover::before {
            left: 100%;
        }

        .btn-delete:hover {
            background: rgba(255, 0, 110, 0.3);
            color: #FFFFFF;
            box-shadow: 0 0 8px rgba(255, 0, 110, 0.3);
            transform: translateY(-1px);
        }

        /* Process Status Styles */
        .process-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .process-status.status-pending {
            background: rgba(107, 114, 128, 0.2);
            color: var(--fc-text-secondary);
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .process-status.status-completed {
            background: rgba(57, 255, 20, 0.2);
            color: var(--fc-neon-success);
            border: 1px solid var(--fc-neon-success);
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.3);
        }

        .process-status.status-completed-late {
            background: rgba(255, 190, 11, 0.2);
            color: var(--fc-neon-warning);
            border: 1px solid var(--fc-neon-warning);
            box-shadow: 0 0 8px rgba(255, 190, 11, 0.3);
        }

        .process-status.status-overdue {
            background: rgba(255, 0, 110, 0.2);
            color: var(--fc-neon-secondary);
            border: 1px solid var(--fc-neon-secondary);
            box-shadow: 0 0 8px rgba(255, 0, 110, 0.3);
            animation: pulse-red 2s infinite;
        }

        .process-status.status-delayed {
            background: rgba(255, 190, 11, 0.2);
            color: var(--fc-neon-warning);
            border: 1px solid var(--fc-neon-warning);
            box-shadow: 0 0 8px rgba(255, 190, 11, 0.3);
        }

        .status-icon {
            font-size: 14px;
            font-weight: bold;
        }

        .status-text {
            font-size: 10px;
        }

        /* Deadline cell styles */
        .deadline-cell {
            font-size: 12px;
            color: var(--fc-text-secondary);
            font-weight: 500;
        }

        /* Assigned to cell styles */
        .assigned-to-cell {
            font-size: 12px;
            color: var(--fc-text-secondary);
            font-weight: 500;
        }

        /* Status button */
        .btn-status {
            background: var(--fc-dark-secondary);
            color: var(--fc-neon-primary);
            border: 1px solid var(--fc-neon-primary);
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            margin-right: 4px;
        }

        .btn-status:hover {
            background: var(--fc-neon-primary);
            color: var(--fc-dark-primary);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        /* Actions Column - Clean Icons Only */
        #processes-table th:last-child {
            text-align: center !important;
            padding: 18px 8px !important;
            vertical-align: middle;
            width: 100px !important;
            min-width: 100px !important;
        }

        #processes-table td:last-child {
            text-align: center;
            padding: 14px 8px !important;
            vertical-align: middle;
            width: 100px !important;
        }

        /* =====================================================
           PROCESS STATUS MODAL STYLES (moved from Diagram.html)
           ===================================================== */

        .process-status-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .process-status-modal-content {
            background: var(--fc-surface);
            border: 2px solid var(--fc-border);
            border-radius: 0; /* Brutalist */
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--fc-shadow-brutal);
        }

        .process-status-modal h3 {
            color: var(--fc-text-primary);
            margin-bottom: 24px;
            font-size: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .status-action-btn {
            padding: 12px 20px;
            border: 2px solid var(--fc-border);
            background: var(--fc-dark-secondary);
            color: var(--fc-text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .status-action-btn:hover {
            background: var(--fc-neon-primary);
            color: var(--fc-dark-primary);
        }

        .status-action-btn.completed {
            border-color: var(--fc-neon-success);
        }

        .status-action-btn.completed:hover {
            background: var(--fc-neon-success);
        }

        .status-action-btn.delayed {
            border-color: var(--fc-neon-warning);
        }

        .status-action-btn.delayed:hover {
            background: var(--fc-neon-warning);
        }

        .status-note-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--fc-border);
            background: var(--fc-dark-secondary);
            color: var(--fc-text-primary);
            margin-top: 12px;
            resize: vertical;
            min-height: 80px;
        }

        .status-note-input:focus {
            outline: none;
            border-color: var(--fc-neon-primary);
        }

        /* =====================================================
           PROJECT MEMBERS MANAGEMENT STYLES
           ===================================================== */
        
        .section-subtitle {
            font-size: 20px;
            font-weight: 700;
            color: var(--fc-text-primary);
            margin: 32px 0 16px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--fc-border);
            padding-bottom: 8px;
        }

        .members-container, .invitations-container {
            margin-bottom: 32px;
        }

        .members-grid, .invitations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .member-card, .invitation-card {
            background: var(--fc-surface);
            border: 2px solid var(--fc-border);
            border-radius: 0; /* Brutalist */
            padding: 24px;
            box-shadow: var(--fc-shadow-brutal);
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
        }

        .member-card:hover, .invitation-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--fc-glow-primary);
        }

        .member-card::before, .invitation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .member-card:hover::before, .invitation-card:hover::before {
            left: 100%;
        }

        .member-info, .invitation-info {
            margin-bottom: 16px;
        }

        .member-email, .invitation-email {
            font-size: 16px;
            font-weight: 600;
            color: var(--fc-text-primary);
            margin-bottom: 8px;
        }

        .member-role, .invitation-role {
            font-size: 14px;
            color: var(--fc-text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .member-role.owner {
            color: var(--fc-neon-primary);
            font-weight: 700;
        }

        .member-role.full-access {
            color: var(--fc-neon-success);
        }

        .member-role.edit-access {
            color: var(--fc-neon-warning);
        }

        .member-role.view-only {
            color: var(--fc-text-muted);
        }

        .member-actions, .invitation-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .member-joined, .invitation-created {
            font-size: 12px;
            color: var(--fc-text-muted);
            margin-top: 12px;
        }

        .invitation-status {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 0;
            margin-top: 8px;
        }

        .invitation-status.pending {
            background: rgba(255, 190, 11, 0.2);
            color: var(--fc-neon-warning);
            border: 1px solid var(--fc-neon-warning);
        }

        .invitation-status.expired {
            background: rgba(255, 0, 110, 0.2);
            color: var(--fc-neon-secondary);
            border: 1px solid var(--fc-neon-secondary);
        }

        .btn-role-change {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid var(--fc-border);
            background: var(--fc-dark-secondary);
            color: var(--fc-text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-role-change:hover {
            background: var(--fc-neon-primary);
            color: var(--fc-dark-primary);
        }

        .btn-remove-member {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid var(--fc-neon-secondary);
            background: rgba(255, 0, 110, 0.1);
            color: var(--fc-neon-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-remove-member:hover {
            background: var(--fc-neon-secondary);
            color: var(--fc-text-primary);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--fc-text-muted);
            font-size: 14px;
            border: 2px dashed var(--fc-border);
            border-radius: 0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Role dropdown styles */
        .role-dropdown {
            position: relative;
            display: inline-block;
        }

        .role-dropdown-content {
            display: none;
            position: absolute;
            background: var(--fc-dark-secondary);
            border: 2px solid var(--fc-border);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            z-index: 99999;
            min-width: 160px;
            top: calc(100% + 2px);
            left: 0;
            border-radius: 6px;
            overflow: visible;
            max-height: 200px;
        }

        .role-dropdown-content.show {
            display: block;
        }

        .role-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--fc-border);
        }

        .role-dropdown-item:hover {
            background: var(--fc-neon-primary);
            color: var(--fc-dark-primary);
        }

        .role-dropdown-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .members-grid, .invitations-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>


    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-container">
        <!-- Loading Bar -->
        <div class="auth-loading-bar" id="auth-loading-bar"></div>

        <!-- Animated Particles -->
        <div class="auth-particles" id="auth-particles"></div>

        <div class="auth-container-inner">
            <!-- Header Section -->
            <div class="auth-header-section">
                <div class="auth-logo-container">
                    <img src="FlowCraft.png" alt="FlowCraft Logo" class="auth-logo">
                    <div>
                        <div class="auth-brand-name">FlowCraft</div>
                        <div class="auth-tagline">Advanced Process Visualization Platform</div>
                    </div>
                </div>

                <div class="auth-hero-content">
                    <h1 class="auth-hero-title">Next-Gen Process Flow</h1>
                    <p class="auth-hero-subtitle">
                        AI-powered visualization platform for complex business processes. 
                        Built for 2025 and beyond.
                    </p>

                    <div class="auth-features-brutal">
                        <div class="auth-feature-brutal">
                            <span>Real-time Process Analytics</span>
                        </div>
                        <div class="auth-feature-brutal">
                            <span>AI-Driven Insights</span>
                        </div>
                        <div class="auth-feature-brutal">
                            <span>Collaborative Workflows</span>
                        </div>
                        <div class="auth-feature-brutal">
                            <span>Advanced Simulations</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auth Card Section -->
            <div class="auth-card-section">
        <div class="auth-card">
            <div class="auth-header">
                        <h1>Access Portal</h1>
                        <p>Enter the FlowCraft ecosystem</p>
            </div>

            <div id="login-form">
                <form id="login-form-element">
                    <div class="form-group">
                                <label for="login-email">Email Address</label>
                                <input type="email" id="login-email" placeholder="your.email@domain.com" autocomplete="username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="••••••••••••" autocomplete="current-password" required>
                    </div>
                    <div style="text-align: right; margin-bottom: 15px;">
                        <a href="#" id="forgot-password" style="color: var(--fc-neon-primary); text-decoration: none; font-size: 14px;">Forgot Password?</a>
                    </div>
                    <button type="submit" class="btn-fc btn-fc-primary btn-fc-full">
                        <span class="btn-text">Initialize Session</span>
                        <div class="loading hidden"></div>
                    </button>
                </form>
                <div class="auth-switch">
                            <span>New to the system? </span>
                            <a href="#" id="show-register">Join Us</a>
                </div>
            </div>

            <div id="register-form" class="hidden">
                <form id="register-form-element">
                    <div class="form-group">
                        <label for="register-name">Full Name</label>
                                <input type="text" id="register-name" placeholder="Full Name" required minlength="2" maxlength="100" title="Full name should contain only letters and spaces, 2-100 characters">
                    </div>
                    <div class="form-group">
                                <label for="register-email">Email Address</label>
                                <input type="email" id="register-email" placeholder="your.email@domain.com" autocomplete="username" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                                <input type="password" id="register-password" placeholder="••••••••••••" autocomplete="new-password" required minlength="12">
                    </div>
                            <button type="submit" class="btn-fc btn-fc-primary btn-fc-full">
                        <span class="btn-text">Create Account</span>
                        <div class="loading hidden"></div>
                    </button>
                </form>
                <div class="auth-switch">
                    <span>Already have an account? </span>
                            <a href="#" id="show-login">Sign In</a>
                        </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Status Indicator -->
        <div class="auth-status-indicator">
            <div class="auth-status-dot"></div>
            <span>System Online</span>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <img src="FlowCraft.png" alt="FlowCraft" style="width: 48px; height: 48px; border-radius: 10px; margin-right: 16px; vertical-align: middle; filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5)); transition: all 0.3s ease;">
                    <span style="font-size: 24px; font-weight: 900; background: linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-transform: uppercase; letter-spacing: 1px;">FlowCraft</span>
                </div>
                <div class="user-menu">
                    <span class="user-info" id="user-email"></span>
                    <button class="btn-fc btn-fc-secondary" id="logout-btn">Logout</button>
                </div>
            </div>
        </header>

        <!-- Projects View -->
        <div id="projects-view" class="container">
            <section class="projects-section">
                <div class="section-header">
                    <h2 class="section-title">My Projects</h2>
                    <button class="btn-fc btn-fc-accent new-project-btn" id="new-project-btn">+ New Project</button>
                </div>
                <div class="projects-grid" id="projects-grid">
                    <!-- Projects will be loaded here -->
                </div>
            </section>
        </div>

        <!-- Workflows View -->
        <div id="sheets-view" class="container sheets-view">
            <div class="breadcrumb">
                <a href="#" id="back-to-projects">Projects</a>
                <span>/</span>
                <span id="current-project-name"></span>
            </div>
            <section class="projects-section">
                <div class="section-header">
                    <h2 class="section-title">Workflows</h2>
                    <button class="btn-fc btn-fc-accent new-project-btn" id="new-sheet-btn">+ New Workflow</button>
                </div>
                <div class="sheets-grid" id="sheets-grid">
                    <!-- Workflows will be loaded here -->
                </div>
            </section>

            <!-- Project Members Management Section -->
            <section class="projects-section" id="project-members-section">
                <div class="section-header">
                    <h2 class="section-title">Project Members</h2>
                    <button class="btn-fc btn-fc-accent new-project-btn" id="invite-member-btn">+ Invite Member</button>
                </div>
                
                <!-- Current Members -->
                <div class="members-container">
                    <div class="members-grid" id="members-grid">
                        <!-- Members will be loaded here -->
                    </div>
                </div>

                <!-- Pending Invitations -->
                <div class="invitations-container" id="invitations-container">
                    <h3 class="section-subtitle">Pending Invitations</h3>
                    <div class="invitations-grid" id="invitations-grid">
                        <!-- Invitations will be loaded here -->
                    </div>
                </div>
            </section>
        </div>

        <!-- Processes Table View -->
        <div id="processes-view" class="container sheets-view">
            <div class="breadcrumb">
                <a href="#" id="back-to-projects-from-processes">Projects</a>
                <span>/</span>
                <a href="#" id="back-to-sheets">Workflows</a>
                <span>/</span>
                <span id="current-sheet-name"></span>
            </div>
            <section class="projects-section">
                <div class="section-header" style="flex-direction: row; justify-content: space-between; align-items: center;">
                    <h2 class="section-title" style="margin: 0; text-align: left;">Processes</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-fc btn-fc-secondary btn-fc-sm" id="manage-columns-btn">⚙️ Manage Columns</button>
                        <button class="btn-fc btn-fc-accent new-project-btn" id="new-process-btn">+ New Process</button>
                        <button class="btn-fc btn-fc-primary btn-fc-sm" id="open-diagram-btn">📊 Open Diagram</button>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <select id="target-month-select" style="padding: 8px; background: var(--fc-dark-secondary); color: var(--fc-text-primary); border: 1px solid var(--fc-border);">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="target-year-select" style="padding: 8px; background: var(--fc-dark-secondary); color: var(--fc-text-primary); border: 1px solid var(--fc-border);">
                            </select>
                            <button class="btn-fc btn-fc-warning btn-fc-sm" id="update-dates-btn">🗓️ Update Dates</button>
                        </div>
                    </div>
                </div>
                <div id="processes-table-container">
                    <table id="processes-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Working Day</th>
                                <th>Due Time</th>
                                <th>Dependencies</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Deadline</th>
                                <th>Assigned To</th>
                                <th id="custom-columns-header"></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="processes-table-body">
                            <!-- Processes will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Project</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="project-form">
                <div class="form-group">
                    <label for="project-name">Project Name</label>
                    <input type="text" id="project-name" required minlength="2" maxlength="100" title="Project name should be 2-100 characters long">
                </div>
                <div class="form-group">
                    <label for="project-description">Description</label>
                    <textarea id="project-description" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-fc btn-fc-primary">Create Project</button>
            </form>
        </div>
    </div>

    <!-- Create Workflow Modal -->
    <div id="sheet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Workflow</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="sheet-form">
                <div class="form-group">
                    <label for="sheet-name">Workflow Name</label>
                    <input type="text" id="sheet-name" required minlength="2" maxlength="100" title="Workflow name should be 2-100 characters long">
                </div>
                <div class="form-group">
                    <label for="sheet-description">Description</label>
                    <textarea id="sheet-description" rows="2"></textarea>
                </div>
                
                <div class="fields-section">
                    <h4>Custom Fields</h4>
                    <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 16px;">
                        Add additional fields for your processes (beyond the required ones)
                    </p>
                    <div id="custom-fields">
                        <!-- Custom fields will be added here -->
                    </div>
                    <button type="button" class="btn-fc btn-fc-secondary btn-fc-sm" id="add-field-btn">+ Add Field</button>
                </div>
                
                <div style="margin-top: 24px;">
                    <button type="submit" class="btn-fc btn-fc-primary">Create Workflow</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create/Edit Process Modal -->
    <div id="process-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="process-modal-title">Create New Process</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="process-form" novalidate>
                <div class="form-group">
                    <label for="process-short-name">Process Name (ID)</label>
                    <input type="text" id="process-short-name" required minlength="1" maxlength="50" title="Process name can contain letters (including Polish characters), numbers, spaces, hyphens and underscores, 1-50 characters" placeholder="e.g., START, Setup, Zamknięcie Ksiąg">
                </div>
                <div class="form-group">
                    <label for="process-description">Description</label>
                    <textarea id="process-description" rows="2" placeholder="Brief description of the process"></textarea>
                </div>
                <div class="form-group">
                    <label for="process-working-day">Working Day</label>
                    <input type="number" id="process-working-day" value="1" required min="-31" max="31" step="1" title="Working day: 1-31 for current month, -1 to -31 for previous month (0 not allowed)" placeholder="e.g., -5, 1, 15 (cannot be 0)">
                    <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">Negative values indicate previous month working days. Cannot be 0.</small>
                </div>
                <div class="form-group">
                    <label for="process-due-time">Due Time (HH:MM format)</label>
                    <input type="text" id="process-due-time" placeholder="e.g., 08:30, 14:00" title="Time format: HH:MM (24-hour format, e.g., 08:30, 14:00) or leave empty">
                </div>
                <div class="form-group">
                    <label for="process-dependencies">Dependencies</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="process-dependencies" placeholder="e.g., START,Setup,Zamknięcie Ksiąg (comma-separated)" title="Dependencies should be comma-separated process names (including Polish characters)" style="flex: 1;">
                        <button type="button" class="btn-fc btn-fc-secondary" onclick="openDependenciesModalFromEdit()" style="padding: 8px 12px; font-size: 12px;">Select...</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="process-type">Process Type</label>
                    <select id="process-type">
                        <option value="standard">Standard</option>
                        <option value="blocking">Blocking</option>
                        <option value="informational">Informational</option>
                    </select>
                </div>
                
                <div id="custom-process-fields">
                    <!-- Custom fields will be added here dynamically -->
                </div>
                
                <div style="margin-top: 24px; display: flex; gap: 12px;">
                    <button type="submit" class="btn-fc btn-fc-success" id="save-process-btn">Save Process</button>
                    <button type="button" class="btn-fc btn-fc-secondary" onclick="closeModals()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Columns Modal -->
    <div id="columns-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manage Table Columns</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <h4 style="color: var(--text); margin-bottom: 12px;">Default Columns</h4>
                <div style="background: var(--background); padding: 12px; border-radius: var(--radius); margin-bottom: 20px;">
                    <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
                        <strong>Fixed columns:</strong> Name, Description, Working Day, Due Time, Dependencies, Type, Actions<br>
                        <em>These columns cannot be removed as they are required for the system.</em>
                    </p>
                </div>
                
                <h4 style="color: var(--text); margin-bottom: 12px;">Custom Columns</h4>
                <div id="existing-columns-list">
                    <!-- Existing custom columns will be listed here -->
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <h5 style="margin-bottom: 8px;">Add New Column</h5>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="new-column-name" placeholder="Column name (e.g., Owner, Priority, Status)" style="flex: 1; padding: 8px 12px; border: 2px solid var(--border); border-radius: var(--radius);" onkeydown="if(event.key === 'Enter') addNewColumn()">
                        <button type="button" class="btn-fc btn-fc-primary btn-fc-sm" id="add-column-btn">Add Column</button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid var(--border);">
                <button type="button" class="btn-fc btn-fc-secondary" onclick="closeModals()">Cancel</button>
                <button type="button" class="btn-fc btn-fc-success" id="save-columns-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Invite Member Modal -->
    <div id="invite-member-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Invite Member to Project</h3>
                <button class="close-btn">&times;</button>
            </div>
            <form id="invite-member-form">
                <div class="form-group">
                    <label for="invite-email">Email Address</label>
                    <input type="email" id="invite-email" required placeholder="Enter email address" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="invite-role">Access Level</label>
                    <select id="invite-role" required>
                        <option value="VIEW_ONLY">View Only - Can view processes and diagrams</option>
                        <option value="EDIT_ACCESS">Edit Access - Can modify processes and create workflows</option>
                        <option value="FULL_ACCESS">Full Access - Can manage everything except project deletion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="invite-message">Personal Message (Optional)</label>
                    <textarea id="invite-message" rows="3" placeholder="Add a personal message to your invitation..."></textarea>
                </div>
                
                <div style="margin-top: 24px; display: flex; gap: 12px;">
                    <button type="submit" class="btn-fc btn-fc-success" id="send-invite-btn">Send Invitation</button>
                    <button type="button" class="btn-fc btn-fc-secondary" onclick="closeModals()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Secure Supabase configuration
        const supabaseConfig = window.FlowCraftSecurity.getSupabaseConfig();
        const supabaseClient = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey);
        
        // Make supabaseClient globally available
        window.supabaseClient = supabaseClient;
        
        // Initialize FlowCraftErrorHandler
        window.FlowCraftErrorHandler = new FlowCraftErrorHandler();

        // Global state
        let currentUser = null;
        let currentProject = null;
        let currentSheet = null;
        let editingProcess = null;
        let columnChanges = {
            toAdd: [],
            toDelete: [],
            toRename: []
        };
        let resetEmailTimer = null;
        let signupEmailTimer = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize security features
            initSecurity();
            await checkAuthState();
            setupEventListeners();
            setupFormValidation();
            initAuthDesign();
        });

        // Initialize security features
        function initSecurity() {
            // Add CSRF tokens to all forms
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                window.FlowCraftErrorHandler.addCSRFToken(form);
            });
            
            // Initialize session timeout
            window.FlowCraftErrorHandler.initSessionTimeout(30);
            
            // Validate configuration
            if (!window.FlowCraftSecurity.validateConfiguration()) {
                window.FlowCraftErrorHandler.showNotification(
                    'Security configuration error. Please contact administrator.', 
                    'error'
                );
            }
            
            console.log('FlowCraft Security initialized');
        }

        // Initialize auth screen design elements
        function initAuthDesign() {
            // Create animated particles for auth screen
            createAuthParticles();
            
            // Initialize logo animation
            initAuthLogoAnimation();
            
            // Remove loading bar after initial load
            setTimeout(() => {
                const loadingBar = document.getElementById('auth-loading-bar');
                if (loadingBar) {
                    loadingBar.style.display = 'none';
                }
            }, 2000);
        }

        // Create floating particles for auth screen
        function createAuthParticles() {
            const particles = document.getElementById('auth-particles');
            if (!particles) return;
            
            const particleCount = 20;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'auth-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                particles.appendChild(particle);
            }
        }

        // Initialize logo animation for auth screen
        function initAuthLogoAnimation() {
            setInterval(() => {
                const logo = document.querySelector('.auth-logo');
                if (!logo) return;
                
                logo.style.animation = 'none';
                logo.offsetHeight; // Force reflow
                logo.style.animation = 'authLogoGlow 2s ease-in-out';
                
                setTimeout(() => {
                    logo.style.animation = '';
                }, 2000);
            }, 10000);

            // Enhanced logo click animation
            const logo = document.querySelector('.auth-logo');
            if (logo) {
                logo.addEventListener('click', () => {
                    logo.style.animation = 'none';
                    logo.offsetHeight; // Force reflow
                    logo.style.animation = 'authLogoGlow 1s ease-in-out';
                    
                    setTimeout(() => {
                        logo.style.animation = '';
                    }, 1000);
                });
            }

            // Add keyframes for auth logo animation
            const logoStyle = document.createElement('style');
            logoStyle.textContent = `
                @keyframes authLogoGlow {
                    0%, 100% { 
                        filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5));
                        transform: scale(1);
                    }
                    50% { 
                        filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.8)) drop-shadow(0 0 40px rgba(255, 0, 110, 0.3));
                        transform: scale(1.05);
                    }
                }
            `;
            document.head.appendChild(logoStyle);
        }

        // Check authentication state
        async function checkAuthState() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                currentUser = user;
                showDashboard();
                
                // Check for pending invitations and show notification
                setTimeout(() => {
                    window.FlowCraftErrorHandler.showPendingInvitationsNotification();
                }, 2000);
                
                // Check for direct sheet access via URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const openSheetId = urlParams.get('openSheet');
                const projectId = urlParams.get('project');
                const invitation = urlParams.get('invitation');
                
                // Handle invitation token if present
                if (invitation) {
                    await handleInvitationToken(invitation);
                    return;
                }
                
                if (openSheetId && projectId) {
                    await loadProjectsAndOpenSheet(projectId, openSheetId);
                } else {
                    loadProjects();
                }
            } else {
                showAuthScreen();
            }
        }

        async function loadProjectsAndOpenSheet(projectId, sheetId) {
            try {
                // Load projects first
                await loadProjects();
                
                // Find and set the current project (check both owned and shared projects)
                const { data: ownedProjects } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                // Also check projects where user is a member
                const { data: memberProjects } = await supabaseClient
                    .from('project_members')
                    .select('project_id')
                    .eq('user_id', currentUser.id);
                
                const memberProjectIds = memberProjects ? memberProjects.map(m => m.project_id) : [];
                
                let sharedProjects = [];
                if (memberProjectIds.length > 0) {
                    const { data: sharedProjectsData } = await supabaseClient
                        .from('projects')
                        .select('*')
                        .in('id', memberProjectIds);
                    sharedProjects = sharedProjectsData || [];
                }
                
                // Combine owned and shared projects
                const allProjects = [...(ownedProjects || []), ...sharedProjects];
                const project = allProjects.find(p => p.id === projectId);
                if (!project) {
                    showNotification('Project not found', 'error');
                    return;
                }
                
                // Load sheet data
                const { data: sheets, error } = await supabaseClient
                    .from('sheets')
                    .select('*')
                    .eq('id', sheetId)
                    .limit(1);
                
                if (error || !sheets || sheets.length === 0) {
                    showNotification('Sheet not found', 'error');
                    return;
                }
                
                const sheet = sheets[0];
                
                // Set current data and show processes view directly
                currentProject = project;
                currentSheet = sheet;
                
                // Show processes view directly
                showProcessesView(sheet);
                
            } catch (error) {
                console.error('Error loading direct sheet access:', error);
                showNotification('Error loading sheet', 'error');
                loadProjects(); // Fallback to normal flow
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Header logo click (only when dashboard is active)
            const logoElement = document.querySelector('.logo');
            if (logoElement) {
                logoElement.addEventListener('click', () => {
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        // Add click animation
                        logoElement.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            logoElement.style.transform = '';
                        }, 150);
                        
                        showProjectsView();
                        showNotification('🏠 Returned to Projects', 'info');
                    }
                });
            }

            // Auth forms
            document.getElementById('login-form-element').addEventListener('submit', handleLogin);
            document.getElementById('register-form-element').addEventListener('submit', handleRegister);
            document.getElementById('show-register').addEventListener('click', () => {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            });
            document.getElementById('show-login').addEventListener('click', () => {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            });

            // Dashboard
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('new-project-btn').addEventListener('click', () => {
                document.getElementById('project-modal').classList.add('active');
            });
            document.getElementById('new-sheet-btn').addEventListener('click', () => {
                document.getElementById('sheet-modal').classList.add('active');
            });
            document.getElementById('back-to-projects').addEventListener('click', showProjectsView);
            document.getElementById('back-to-projects-from-processes').addEventListener('click', showProjectsView);
            document.getElementById('back-to-sheets').addEventListener('click', () => showSheetsView(currentProject));
            document.getElementById('new-process-btn').addEventListener('click', () => {
                editingProcess = null;
                openProcessModal();
            });
            document.getElementById('open-diagram-btn').addEventListener('click', openDiagramFromProcesses);
            document.getElementById('manage-columns-btn').addEventListener('click', openColumnsModal);
            document.getElementById('update-dates-btn').addEventListener('click', updateProcessDates);
            document.getElementById('invite-member-btn').addEventListener('click', openInviteMemberModal);

            // Modals
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });
            document.getElementById('project-form').addEventListener('submit', handleCreateProject);
            document.getElementById('sheet-form').addEventListener('submit', handleCreateSheet);
            document.getElementById('process-form').addEventListener('submit', handleSaveProcess);
            document.getElementById('invite-member-form').addEventListener('submit', handleInviteMember);
            document.getElementById('add-field-btn').addEventListener('click', addCustomField);
            document.getElementById('add-column-btn').addEventListener('click', addNewColumn);
            document.getElementById('save-columns-btn').addEventListener('click', saveColumnChanges);

            // Close modals on backdrop click (except process-modal)
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal && modal.id !== 'process-modal') {
                        closeModals();
                    }
                });
            });
        }

        // Authentication handlers
        async function handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const btnText = btn.querySelector('.btn-text');
            const loading = btn.querySelector('.loading');
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                // Enhanced security validation
                window.FlowCraftErrorHandler.validateForm(e.target);
                window.FlowCraftErrorHandler.validateEmail(email);
                
                // Rate limiting check
                window.FlowCraftErrorHandler.checkRateLimit(email, 'login');
                
                // Sanitize inputs
                const sanitizedEmail = window.FlowCraftErrorHandler.sanitizeInput(email);
                const sanitizedPassword = window.FlowCraftErrorHandler.sanitizeInput(password);
                
                // FlowCraft 2025 Auth Animation
                const originalText = btnText.textContent;
                btnText.textContent = 'AUTHENTICATING...';
                btn.style.background = 'linear-gradient(135deg, var(--fc-neon-accent) 0%, var(--fc-neon-warning) 100%)';
                
                btnText.classList.add('hidden');
                loading.classList.remove('hidden');

                // Enhanced login with error handling using sanitized inputs
                const result = await window.FlowCraftErrorHandler.executeSupabaseRequest(
                    () => supabaseClient.auth.signInWithPassword({ 
                        email: sanitizedEmail, 
                        password: sanitizedPassword 
                    }),
                    { 
                        showLoading: false, // We handle UI ourselves
                        maxRetries: 2 
                    }
                );

                // Clear rate limit on successful login
                window.FlowCraftErrorHandler.clearRateLimit(sanitizedEmail);
                
                btnText.textContent = 'ACCESS GRANTED';
                btn.style.background = 'linear-gradient(135deg, var(--fc-neon-success) 0%, var(--fc-neon-primary) 100%)';
                
                window.FlowCraftErrorHandler.showNotification('Login successful!', 'success');
                
                setTimeout(() => {
                    currentUser = result.data.user;
                    showDashboard();
                    loadProjects();
                    
                    // Check for invitation token after login
                    const urlParams = new URLSearchParams(window.location.search);
                    const invitationToken = urlParams.get('invitation');
                    if (invitationToken) {
                        handleInvitationToken(invitationToken);
                    }
                }, 1000);

            } catch (error) {
                // Reset button state
                const originalText = btnText.textContent === 'AUTHENTICATING...' ? 'LOGIN' : btnText.textContent;
                btnText.textContent = originalText;
                btn.style.background = 'linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 100%)';
                
                // Handle and display error
                window.FlowCraftErrorHandler.handleError(error);
            } finally {
                btnText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const btnText = btn.querySelector('.btn-text');
            const loading = btn.querySelector('.loading');
            
            if (signupEmailTimer) {
                showNotification(`Please wait ${signupEmailTimer} seconds before trying to register again`, 'warning');
                return;
            }

            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            try {
                // Enhanced security validation
                window.FlowCraftErrorHandler.validateForm(e.target);
                
                // Rate limiting check for registration
                window.FlowCraftErrorHandler.checkRateLimit(email, 'register');
                
                // Validate and sanitize inputs
                if (!name || !name.trim()) {
                    throw new Error('Full name is required');
                }
                if (name.trim().length < 2) {
                    throw new Error('Full name must be at least 2 characters long');
                }
                
                window.FlowCraftErrorHandler.validateEmail(email);
                window.FlowCraftErrorHandler.validatePassword(password);
                
                // Sanitize inputs
                const sanitizedName = window.FlowCraftErrorHandler.sanitizeInput(name);
                const sanitizedEmail = window.FlowCraftErrorHandler.sanitizeInput(email);
                const sanitizedPassword = window.FlowCraftErrorHandler.sanitizeInput(password);
                
                // FlowCraft 2025 Auth Animation
                const originalText = btnText.textContent;
                btnText.textContent = 'CREATING ACCOUNT...';
                btn.style.background = 'linear-gradient(135deg, var(--fc-neon-accent) 0%, var(--fc-neon-warning) 100%)';
                
                btnText.classList.add('hidden');
                loading.classList.remove('hidden');

                // Enhanced registration with error handling using sanitized inputs
                const result = await window.FlowCraftErrorHandler.executeSupabaseRequest(
                    () => supabaseClient.auth.signUp({
                        email: sanitizedEmail, 
                        password: sanitizedPassword,
                        options: {
                            data: { full_name: sanitizedName.trim() }
                        }
                    }),
                    { 
                        showLoading: false, // We handle UI ourselves
                        maxRetries: 1  // Don't retry registration
                    }
                );
                
                // Clear rate limit on successful registration
                window.FlowCraftErrorHandler.clearRateLimit(sanitizedEmail);

                btnText.textContent = 'ACCOUNT CREATED';
                btn.style.background = 'linear-gradient(135deg, var(--fc-neon-success) 0%, var(--fc-neon-primary) 100%)';
                
                setTimeout(() => {
                    window.FlowCraftErrorHandler.showNotification('Account created! Please check your email to verify.', 'success');
                    // Switch to login form
                    document.getElementById('register-form').classList.add('hidden');
                    document.getElementById('login-form').classList.remove('hidden');
                    // Clear form
                    document.getElementById('register-name').value = '';
                    document.getElementById('register-email').value = '';
                    document.getElementById('register-password').value = '';
                }, 1000);

            } catch (error) {
                // Handle rate limiting specially
                if (error.message && error.message.includes('rate limit')) {
                    // Start 60 second timer
                    let timeLeft = 60;
                    signupEmailTimer = timeLeft;
                    
                    const countdownInterval = setInterval(() => {
                        timeLeft -= 1;
                        signupEmailTimer = timeLeft;
                        btnText.textContent = `WAIT ${timeLeft}s`;
                        
                        if (timeLeft <= 0) {
                            clearInterval(countdownInterval);
                            signupEmailTimer = null;
                            btnText.textContent = 'REGISTER';
                            btn.style.background = 'linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 100%)';
                        }
                    }, 1000);

                    window.FlowCraftErrorHandler.showNotification('Please wait a minute before trying to register again', 'warning');
                } else {
                    // Reset button state
                    btnText.textContent = 'REGISTER';
                    btn.style.background = 'linear-gradient(135deg, var(--fc-neon-primary) 0%, var(--fc-neon-secondary) 100%)';
                    
                    // Handle and display error
                    window.FlowCraftErrorHandler.handleError(error);
                }
            } finally {
                if (!signupEmailTimer) {
                    btnText.classList.remove('hidden');
                    loading.classList.add('hidden');
                }
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentProject = null;
            showAuthScreen();
        }

        // Screen management
        function showAuthScreen() {
            document.getElementById('auth-screen').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            
            // Show auth status indicator
            const authStatus = document.querySelector('.auth-status-indicator');
            if (authStatus) authStatus.style.display = 'flex';
        }

        function showDashboard() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('user-email').textContent = currentUser.email;
            
            // Hide auth status indicator
            const authStatus = document.querySelector('.auth-status-indicator');
            if (authStatus) authStatus.style.display = 'none';
            
            showProjectsView();
        }

        function showProjectsView() {
            document.getElementById('projects-view').style.display = 'block';
            document.getElementById('sheets-view').classList.remove('active');
            document.getElementById('processes-view').classList.remove('active');
            currentProject = null;
            currentSheet = null;
        }

        function showSheetsView(project) {
            currentProject = project;
            document.getElementById('projects-view').style.display = 'none';
            document.getElementById('sheets-view').classList.add('active');
            document.getElementById('processes-view').classList.remove('active');
            document.getElementById('current-project-name').textContent = project.name;
            loadSheets();
        }

        function showProcessesView(sheet) {
            currentSheet = sheet;
            document.getElementById('projects-view').style.display = 'none';
            document.getElementById('sheets-view').classList.remove('active');
            document.getElementById('processes-view').classList.add('active');
            document.getElementById('current-sheet-name').textContent = sheet.name;
            initializeDateSelectors();
            loadProcesses();
            // Auto-update dates for current month on first load
            setTimeout(() => updateProcessDates(), 1000);
        }

        // Project management
        async function loadProjects() {
            try {
                // Get projects where user is owner OR member
                const result = await window.FlowCraftErrorHandler.executeSupabaseRequest(
                    async () => {
                        // First get projects where user is owner
                        const ownedProjectsResult = await supabaseClient
                            .from('projects')
                            .select('*')
                            .eq('user_id', currentUser.id);
                        
                        if (ownedProjectsResult.error) {
                            console.error('Error loading owned projects:', ownedProjectsResult.error);
                        }
                        
                        // Add role info for owned projects
                        const ownedProjects = (ownedProjectsResult.data || []).map(project => ({
                            ...project,
                            user_role: 'OWNER',
                            is_member: false
                        }));
                        
                        // Get project memberships
                        const membershipResult = await supabaseClient
                            .from('project_members')
                            .select('project_id, role')
                            .eq('user_id', currentUser.id);
                        
                        if (membershipResult.error) {
                            console.error('Error loading project memberships:', membershipResult.error);
                        }
                        
                        // Get project details for memberships
                        let memberProjects = [];
                        if (membershipResult.data && membershipResult.data.length > 0) {
                            const projectIds = membershipResult.data.map(m => m.project_id);
                            const memberProjectsResult = await supabaseClient
                                .from('projects')
                                .select('*')
                                .in('id', projectIds);
                            
                            // Combine project data with role data
                            memberProjects = (memberProjectsResult.data || []).map(project => {
                                const membership = membershipResult.data.find(m => m.project_id === project.id);
                                return {
                                    ...project,
                                    user_role: membership ? membership.role : 'VIEW_ONLY',
                                    is_member: true
                                };
                            });
                        }
                        
                        // Combine and deduplicate (in case user is both owner and member)
                        const allProjects = [...ownedProjects];
                        memberProjects.forEach(memberProject => {
                            if (!allProjects.find(p => p.id === memberProject.id)) {
                                allProjects.push(memberProject);
                            }
                        });
                        
                        // Sort by created_at descending
                        allProjects.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        
                        return { data: allProjects, error: null };
                    },
                    { 
                        loadingMessage: 'Loading projects...'
                    }
                );

                const grid = document.getElementById('projects-grid');
                grid.innerHTML = '';

                if (result.data && result.data.length > 0) {
                    result.data.forEach(project => {
                        const card = createProjectCard(project);
                        grid.appendChild(card);
                    });
                } else {
                    // Show empty state
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--fc-text-muted);">
                            <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                            <h3 style="color: var(--fc-text-secondary); margin-bottom: 8px;">No Projects Yet</h3>
                            <p>Create your first project to get started</p>
                        </div>
                    `;
                }

            } catch (error) {
                window.FlowCraftErrorHandler.handleError(error);
                // Show error state in grid
                const grid = document.getElementById('projects-grid');
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--fc-text-muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                        <h3 style="color: var(--fc-neon-secondary); margin-bottom: 8px;">Failed to Load Projects</h3>
                        <p>Please check your connection and try again</p>
                        <button onclick="loadProjects()" style="margin-top: 16px; padding: 8px 16px; background: var(--fc-neon-primary); color: var(--fc-dark-primary); border: none; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'project-card';
            
            // Create safe DOM elements instead of innerHTML
            const projectHeader = document.createElement('div');
            projectHeader.className = 'project-header';
            
            const projectName = document.createElement('h3');
            projectName.className = 'project-name';
            projectName.textContent = project.name; // Safe text content
            
            // Add user role indicator
            if (project.user_role && project.user_role !== 'OWNER') {
                const roleIndicator = document.createElement('span');
                roleIndicator.className = 'user-role-indicator';
                roleIndicator.textContent = project.user_role.replace('_', ' ');
                roleIndicator.style.cssText = `
                    font-size: 12px; 
                    background: var(--fc-neon-secondary); 
                    color: white; 
                    padding: 2px 8px; 
                    border-radius: 12px; 
                    margin-left: 8px;
                    font-weight: 500;
                `;
                projectName.appendChild(roleIndicator);
            }
            
            projectHeader.appendChild(projectName);
            
            // Add delete button (only for project owners)
            if (!project.is_member || project.user_role === 'OWNER') {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete-project';
                deleteBtn.innerHTML = '🗑️';
                deleteBtn.title = 'Delete Project';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent card click
                    deleteProject(project.id, project.name);
                };
                projectHeader.appendChild(deleteBtn);
            }
            
            const projectDescription = document.createElement('p');
            projectDescription.className = 'project-description';
            projectDescription.textContent = project.description || 'No description'; // Safe text content
            
            const projectStats = document.createElement('div');
            projectStats.className = 'project-stats';
            
            const sheetsSpan = document.createElement('span');
            sheetsSpan.textContent = `📊 Workflows: ${project.sheet_count || 0}`;
            
            const dateSpan = document.createElement('span');
            dateSpan.textContent = `📅 ${new Date(project.created_at).toLocaleDateString()}`;
            
            projectStats.appendChild(sheetsSpan);
            projectStats.appendChild(dateSpan);
            
            card.appendChild(projectHeader);
            card.appendChild(projectDescription);
            card.appendChild(projectStats);
            
            card.addEventListener('click', () => showSheetsView(project));
            return card;
        }

        async function handleCreateProject(e) {
            e.preventDefault();
            const name = document.getElementById('project-name').value;
            const description = document.getElementById('project-description').value;

            const { data, error } = await supabaseClient
                .from('projects')
                .insert([{
                    name,
                    description,
                    user_id: currentUser.id
                }])
                .select()
                .single();

            if (error) {
                showNotification('Error creating project', 'error');
            } else {
                showNotification('Project created successfully!', 'success');
                closeModals();
                loadProjects();
                document.getElementById('project-form').reset();
            }
        }

        // Sheet management
        async function loadSheets() {
            console.log('=== DEBUG loadSheets() ===');
            console.log('Current project:', currentProject);
            console.log('Project ID:', currentProject?.id);
            console.log('User role in project:', currentProject?.user_role);
            console.log('Is member:', currentProject?.is_member);
            
            // First test: Query ALL sheets without project filter to see RLS in action
            console.log('Testing RLS: Querying ALL sheets (should only return accessible ones)');
            const { data: allSheets, error: allError } = await supabaseClient
                .from('sheets')
                .select('*')
                .order('created_at', { ascending: false });
            
            console.log('ALL sheets query (RLS filtered):', { data: allSheets, error: allError });
            
            // Second test: Query with project filter
            const { data: sheets, error } = await supabaseClient
                .from('sheets')
                .select('*')
                .eq('project_id', currentProject.id)
                .order('created_at', { ascending: false });

            console.log('Project-filtered sheets query:', { data: sheets, error });
            console.log('Number of sheets found:', sheets?.length || 0);
            
            // Third test: Check current user's memberships
            console.log('Testing project memberships for current user:');
            const { data: memberships, error: memberError } = await supabaseClient
                .from('project_members')
                .select('project_id, role')
                .eq('user_id', currentUser.id);
            
            console.log('User memberships:', { data: memberships, error: memberError });

            if (error) {
                console.error('Sheets loading error details:', error);
                showNotification('Error loading workflows', 'error');
                return;
            }

            const grid = document.getElementById('sheets-grid');
            grid.innerHTML = '';

            if (!sheets || sheets.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--fc-text-muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <h3 style="color: var(--fc-text-secondary); margin-bottom: 8px;">No Workflows Yet</h3>
                        <p>Create your first workflow to get started</p>
                    </div>
                `;
                return;
            }

            sheets.forEach(sheet => {
                console.log('Creating card for sheet:', sheet.name);
                const card = createSheetCard(sheet);
                grid.appendChild(card);
            });
        }

        function createSheetCard(sheet) {
            const card = document.createElement('div');
            card.className = 'sheet-card';
            
            // Create safe DOM elements instead of innerHTML
            const title = document.createElement('h3');
            title.style.cssText = 'margin-bottom: 16px; font-size: 20px; font-weight: 700; color: var(--fc-text-primary); text-transform: uppercase; letter-spacing: 1px; position: relative; z-index: 2; margin: 0 0 16px 0;';
            title.textContent = sheet.name; // Safe text content
            
            const description = document.createElement('p');
            description.style.cssText = 'color: var(--fc-text-secondary); margin-bottom: 20px; line-height: 1.6; font-size: 14px; position: relative; z-index: 2;';
            description.textContent = sheet.description || 'No description'; // Safe text content
            
            const stats = document.createElement('div');
            stats.style.cssText = 'font-size: 13px; color: var(--fc-text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; position: relative; z-index: 2;';
            
            const statsSpan = document.createElement('span');
            statsSpan.style.cssText = 'display: flex; align-items: center; gap: 6px;';
            statsSpan.textContent = `🔧 Custom Fields: ${Object.keys(sheet.custom_fields || {}).length}`;
            
            stats.appendChild(statsSpan);
            
            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-delete-sheet';
            deleteBtn.innerHTML = '🗑️ Delete';
            deleteBtn.title = 'Delete Sheet';
            deleteBtn.style.cssText = 'position: absolute; top: 12px; right: 12px; z-index: 3;';
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent card click
                deleteSheet(sheet.id, sheet.name);
            };
            
            card.appendChild(title);
            card.appendChild(description);
            card.appendChild(stats);
            card.appendChild(deleteBtn);
            
            card.addEventListener('click', () => openProcesses(sheet));
            return card;
        }

        async function handleCreateSheet(e) {
            e.preventDefault();
            const name = document.getElementById('sheet-name').value;
            const description = document.getElementById('sheet-description').value;
            
            // Get custom fields
            const customFields = {};
            document.querySelectorAll('.field-item input').forEach(input => {
                if (input.value.trim()) {
                    customFields[input.value.trim()] = 'text'; // default type
                }
            });

            const { data, error } = await supabaseClient
                .from('sheets')
                .insert([{
                    name,
                    description,
                    project_id: currentProject.id,
                    custom_fields: customFields
                }])
                .select()
                .single();

            if (error) {
                showNotification('Error creating workflow', 'error');
            } else {
                showNotification('Workflow created successfully!', 'success');
                closeModals();
                loadSheets();
                document.getElementById('sheet-form').reset();
                document.getElementById('custom-fields').innerHTML = '';
            }
        }

        // Custom fields management
        function addCustomField() {
            const container = document.getElementById('custom-fields');
            const fieldItem = document.createElement('div');
            fieldItem.className = 'field-item';
            fieldItem.innerHTML = `
                <input type="text" placeholder="Field name (e.g., Priority, Owner, etc.)" />
                <button type="button" class="btn btn-secondary btn-small" onclick="this.parentElement.remove()">Remove</button>
            `;
            container.appendChild(fieldItem);
        }

        // Open processes table instead of diagram directly
        function openProcesses(sheet) {
            currentSheet = sheet;
            showProcessesView(sheet);
        }

        // Open diagram from processes view
        function openDiagramFromProcesses() {
            if (!currentSheet) return;
            showNotification(`Opening diagram for: ${currentSheet.name}`, 'success');
            // Redirect to Diagram.html with sheet and project parameters
            window.location.href = `Diagram.html?sheet=${currentSheet.id}&project=${currentProject.id}`;
        }

        // Utility functions
        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Global processes variable for status management
        let currentProcesses = [];

        // Process management functions
        async function loadProcesses() {
            if (!currentSheet) return;

            const { data: processes, error } = await supabaseClient
                .from('processes')
                .select('*')
                .eq('sheet_id', currentSheet.id)
                .order('working_day', { ascending: true })
                .order('due_time', { ascending: true });

            if (error) {
                showNotification('Error loading processes', 'error');
                console.error('Error:', error);
                return;
            }

            // Store processes globally for status management
            currentProcesses = processes || [];
            renderProcessesTable(processes);
        }

        function renderProcessesTable(processes) {
            const tbody = document.getElementById('processes-table-body');
            tbody.innerHTML = '';

            // Generate custom column headers
            const customFields = currentSheet.custom_fields || {};
            const customFieldsArray = Object.keys(customFields);
            const customColumnsHeader = document.getElementById('custom-columns-header');
            
            if (customFieldsArray.length > 0) {
                customColumnsHeader.innerHTML = customFieldsArray.map(field => 
                    `<th>${field}</th>`
                ).join('');
            } else {
                customColumnsHeader.innerHTML = '';
            }

            processes.forEach(process => {
                const row = createProcessRow(process, customFieldsArray);
                tbody.appendChild(row);
            });
        }

        function createProcessRow(process, customFields) {
            const row = document.createElement('tr');
            
            const customData = process.custom_data || {};
            const customFieldsHTML = customFields.map(field => 
                `<td><input type="text" class="inline-edit" data-field="${field}" data-process-id="${process.id}" value="${customData[field] || ''}" onblur="updateProcessField(this)"></td>`
            ).join('');

            // Calculate deadline based on working day and current month
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-indexed, convert to 1-indexed
            const currentYear = currentDate.getFullYear();
            let deadline = 'Not set';
            
            if (process.working_day && process.due_time) {
                // Use proper working day calculation if available, otherwise fallback to simplified version
                if (process.due_date) {
                    // Use the calculated due_date from backend if available
                    const dueDateTime = new Date(process.due_date);
                    const timeParts = process.due_time.split(':');
                    dueDateTime.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]));
                    deadline = dueDateTime.toLocaleDateString('pl-PL') + ' ' + process.due_time;
                } else {
                    // Fallback calculation for display purposes (not accurate for Wd calculations)
                    const workingDay = parseInt(process.working_day);
                    let targetMonth = currentMonth;
                    let targetYear = currentYear;
                    
                    if (workingDay < 0) {
                        targetMonth = currentMonth - 1;
                        if (targetMonth <= 0) {
                            targetMonth = 12;
                            targetYear--;
                        }
                    }
                    
                    // This is a simplified calculation - real working days should be calculated server-side
                    const approximateDate = new Date(targetYear, targetMonth - 1, Math.abs(workingDay) * 2); // Rough approximation
                    deadline = approximateDate.toLocaleDateString('pl-PL') + ' ' + process.due_time + ' (approx)';
                }
            }
            
            // Format status with icon
            const statusText = process.status || 'PENDING';
            const statusIcon = {
                'PENDING': '○',
                'COMPLETED_ON_TIME': '✓',
                'COMPLETED_LATE': '✓',
                'OVERDUE': '⚠',
                'DELAYED_WITH_REASON': '⏱'
            }[statusText] || '○';
            
            const statusClass = {
                'PENDING': 'status-pending',
                'COMPLETED_ON_TIME': 'status-completed',
                'COMPLETED_LATE': 'status-completed-late',
                'OVERDUE': 'status-overdue',
                'DELAYED_WITH_REASON': 'status-delayed'
            }[statusText] || 'status-pending';

            row.innerHTML = `
                <td><input type="text" class="inline-edit" data-field="short_name" data-process-id="${process.id}" value="${process.short_name}" onblur="updateProcessField(this)"></td>
                <td class="description-cell" data-full-description="${process.description || ''}" onclick="editDescription(${process.id}, '${(process.description || '').replace(/'/g, '\\\'').replace(/"/g, '&quot;')}', this)">${process.description || ''}</td>
                <td><input type="number" class="inline-edit" data-field="working_day" data-process-id="${process.id}" value="${process.working_day}" onblur="updateProcessField(this)" title="Cannot be 0. Negative values indicate previous month."></td>
                <td><input type="text" class="inline-edit" data-field="due_time" data-process-id="${process.id}" value="${process.due_time || ''}" onblur="updateProcessField(this)" placeholder="HH:MM"></td>
                <td class="dependencies-cell">
                    <button class="dependencies-selector" onclick="openDependenciesModal(${process.id}, '${(process.dependencies || '').replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')">${process.dependencies || 'Select dependencies...'}</button>
                </td>
                <td>
                    <div class="process-type-display" data-process-id="${process.id}" data-type="${process.process_type}" onclick="toggleProcessType(this)">
                        <span class="type-abbreviation" title="${getProcessTypeFullName(process.process_type)}">${getProcessTypeAbbreviation(process.process_type)}</span>
                    </div>
                </td>
                <td>
                    <div class="process-status ${statusClass}">
                        <span class="status-icon">${statusIcon}</span>
                        <span class="status-text">${statusText.replace('_', ' ')}</span>
                    </div>
                </td>
                <td class="deadline-cell">${deadline}</td>
                <td class="assigned-to-cell">${process.assigned_to_email || 'Not assigned'}</td>
                ${customFieldsHTML}
                <td>
                    <div class="process-actions">
                        <button class="btn-status" onclick="openProcessStatusModal('${process.id}')" title="Change Status">⚙️</button>
                        <button class="btn-edit" onclick="editProcess('${process.id}')" title="Edit Process">✏️</button>
                        <button class="btn-delete" onclick="deleteProcess('${process.id}')" title="Delete Process">🗑️</button>
                    </div>
                </td>
            `;
            return row;
        }

        async function updateProcessField(element) {
            const processId = element.dataset.processId;
            const field = element.dataset.field;
            const value = element.value;

            try {
                let updateData = {};
                
                if (['short_name', 'description', 'working_day', 'due_time', 'dependencies', 'process_type'].includes(field)) {
                    if (field === 'working_day') {
                        const workingDayValue = parseInt(value);
                        if (workingDayValue === 0) {
                            showNotification('Working Day cannot be 0. Use positive numbers for current month or negative for previous month.', 'error');
                            element.focus();
                            return;
                        }
                        updateData[field] = workingDayValue || 1;
                    } else {
                        updateData[field] = value;
                    }
                } else {
                    // Custom field - update custom_data JSON
                    const { data: processData } = await supabaseClient
                        .from('processes')
                        .select('custom_data')
                        .eq('id', processId)
                        .limit(1);

                    const currentProcess = processData && processData.length > 0 ? processData[0] : null;
                    const customData = currentProcess?.custom_data || {};
                    customData[field] = value;
                    updateData.custom_data = customData;
                }

                const { error } = await supabaseClient
                    .from('processes')
                    .update(updateData)
                    .eq('id', processId);

                if (error) {
                    showNotification('Error updating process', 'error');
                    console.error('Error:', error);
                } else {
                    element.style.backgroundColor = 'rgba(0, 212, 255, 0.15)';
                    element.style.borderColor = 'rgba(0, 212, 255, 0.6)';
                    setTimeout(() => {
                        element.style.backgroundColor = '';
                        element.style.borderColor = '';
                    }, 1200);
                }
            } catch (error) {
                showNotification('Error updating process', 'error');
                console.error('Error:', error);
            }
        }

        function openProcessModal() {
            const modal = document.getElementById('process-modal');
            const title = document.getElementById('process-modal-title');
            const form = document.getElementById('process-form');
            
            title.textContent = editingProcess ? 'Edit Process' : 'Create New Process';
            
            if (editingProcess) {
                // Populate form with existing data
                document.getElementById('process-short-name').value = editingProcess.short_name;
                document.getElementById('process-description').value = editingProcess.description || '';
                document.getElementById('process-working-day').value = editingProcess.working_day;
                document.getElementById('process-due-time').value = editingProcess.due_time || '';
                document.getElementById('process-dependencies').value = editingProcess.dependencies || '';
                document.getElementById('process-type').value = editingProcess.process_type || 'standard';
            } else {
                form.reset();
            }

            // Add custom fields
            renderCustomProcessFields();
            
            modal.classList.add('active');
        }

        function renderCustomProcessFields() {
            const container = document.getElementById('custom-process-fields');
            container.innerHTML = '';
            
            const customFields = currentSheet.custom_fields || {};
            const customData = editingProcess?.custom_data || {};
            
            Object.keys(customFields).forEach(fieldName => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'form-group';
                fieldDiv.innerHTML = `
                    <label for="custom-${fieldName}">${fieldName}</label>
                    <input type="text" id="custom-${fieldName}" class="custom-field" data-field="${fieldName}" 
                           value="${customData[fieldName] || ''}">
                `;
                container.appendChild(fieldDiv);
            });
        }

        async function handleSaveProcess(e) {
            e.preventDefault();
            
            // Get button reference outside try block
            const submitBtn = document.getElementById('save-process-btn');
            const originalText = submitBtn.textContent;
            
            try {
                // Custom form validation before submit
                if (!validateProcessForm()) {
                    // Reset button if validation fails
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                // Show loading state
                submitBtn.textContent = editingProcess ? 'Updating...' : 'Creating...';
                submitBtn.disabled = true;
                
                const workingDayValue = parseInt(document.getElementById('process-working-day').value);
                
                // Enhanced validation using error handler
                const formData = {
                    short_name: document.getElementById('process-short-name').value?.trim(),
                    description: document.getElementById('process-description').value?.trim(),
                    working_day: workingDayValue || 1,
                    due_time: document.getElementById('process-due-time').value?.trim() || null,
                    dependencies: document.getElementById('process-dependencies').value?.trim() || '',
                    process_type: document.getElementById('process-type').value,
                    sheet_id: currentSheet.id
                };

                // Validate process data
                window.FlowCraftErrorHandler.validateProcessData(formData);

                // Collect custom fields with sanitization
                const customData = {};
                document.querySelectorAll('.custom-field').forEach(input => {
                    const fieldName = input.dataset.field;
                    const value = window.FlowCraftErrorHandler.sanitizeInput(input.value?.trim() || '');
                    if (value) {
                        customData[fieldName] = value;
                    }
                });
                formData.custom_data = customData;

                // Execute save operation with error handling
                const operation = editingProcess ? 
                    () => supabaseClient
                        .from('processes')
                        .update(formData)
                        .eq('id', editingProcess.id) :
                    () => supabaseClient
                        .from('processes')
                        .insert([formData]);

                await window.FlowCraftErrorHandler.executeSupabaseRequest(
                    operation,
                    { 
                        loadingMessage: editingProcess ? 'Updating process...' : 'Creating process...'
                    }
                );

                window.FlowCraftErrorHandler.showNotification(
                    editingProcess ? 'Process updated successfully!' : 'Process created successfully!', 
                    'success'
                );
                
                closeModals();
                loadProcesses();

            } catch (error) {
                window.FlowCraftErrorHandler.handleError(error);
            } finally {
                // Reset button state
                const submitBtn = document.getElementById('save-process-btn');
                if (submitBtn) {
                    submitBtn.textContent = originalText || 'Save Process';
                    submitBtn.disabled = false;
                }
            }
        }

        // Description tooltip and editing functions
        function editDescription(processId, currentDescription, targetElement) {
            if (!targetElement) {
                console.error('editDescription: targetElement is required');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentDescription;
            input.className = 'inline-edit';
            input.style.width = '100%';
            
            const cell = targetElement;
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            
            input.onblur = function() {
                updateProcessDescription(processId, input.value, cell);
                cell.innerHTML = input.value;
                cell.setAttribute('data-full-description', input.value);
            };
            
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
        }
        
        async function updateProcessDescription(processId, description, targetElement) {
            try {
                const { error } = await supabaseClient
                    .from('processes')
                    .update({ description: description })
                    .eq('id', processId);

                if (error) {
                    showNotification('Error updating description', 'error');
                    console.error('Error:', error);
                } else {
                    // Show success feedback
                    if (targetElement) {
                        targetElement.style.backgroundColor = 'rgba(0, 212, 255, 0.15)';
                        setTimeout(() => {
                            targetElement.style.backgroundColor = '';
                        }, 1200);
                    }
                }
            } catch (error) {
                showNotification('Error updating description', 'error');
                console.error('Error:', error);
            }
        }
        
        // Initialize tooltips for descriptions
        document.addEventListener('DOMContentLoaded', function() {
            initializeDescriptionTooltips();
        });
        
        function initializeDescriptionTooltips() {
            document.addEventListener('mouseenter', function(e) {
                if (e.target && e.target.classList && e.target.classList.contains('description-cell')) {
                    const fullDescription = e.target.getAttribute('data-full-description');
                    const displayedText = e.target.textContent;
                    
                    if (fullDescription && fullDescription.length > displayedText.length) {
                        showDescriptionTooltip(e.target, fullDescription);
                    }
                }
            }, true);
            
            document.addEventListener('mouseleave', function(e) {
                if (e.target && e.target.classList && e.target.classList.contains('description-cell')) {
                    hideDescriptionTooltip();
                }
            }, true);
        }
        
        let currentTooltip = null;
        
        function showDescriptionTooltip(element, text) {
            if (!element) return;
            
            hideDescriptionTooltip();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'description-tooltip show';
            tooltip.textContent = text;
            
            document.body.appendChild(tooltip);
            
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left;
            let top = rect.bottom + 5;
            
            // Adjust position if tooltip goes off screen
            if (left + tooltipRect.width > window.innerWidth) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            
            if (top + tooltipRect.height > window.innerHeight) {
                top = rect.top - tooltipRect.height - 5;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            
            currentTooltip = tooltip;
        }
        
        function hideDescriptionTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }
        
        // Process form validation with better error messages
        function validateProcessForm() {
            const processName = document.getElementById('process-short-name');
            const dueTime = document.getElementById('process-due-time');
            const dependencies = document.getElementById('process-dependencies');
            const workingDay = document.getElementById('process-working-day');
            
            // Process Name validation
            if (!processName.value || !processName.value.trim()) {
                showCustomValidationError(processName, 'Process name is required');
                return false;
            }
            
            if (!/^[A-Za-z0-9ĄąĆćĘęŁłŃńÓóŚśŹźŻż_\s-]+$/.test(processName.value)) {
                showCustomValidationError(processName, 'Process name can contain letters (including Polish characters), numbers, spaces, hyphens and underscores');
                return false;
            }
            
            // Working Day validation
            const workingDayValue = parseInt(workingDay.value);
            if (isNaN(workingDayValue) || workingDayValue === 0 || workingDayValue > 31 || workingDayValue < -31) {
                showCustomValidationError(workingDay, 'Working day must be 1-31 for current month or -1 to -31 for previous month (cannot be 0)');
                return false;
            }
            
            // Due Time validation (optional)
            if (dueTime.value && !/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(dueTime.value)) {
                showCustomValidationError(dueTime, 'Time must be in HH:MM format (e.g., 08:30, 14:00)');
                return false;
            }
            
            // Dependencies validation (optional)
            if (dependencies.value && !/^([A-Za-z0-9ĄąĆćĘęŁłŃńÓóŚśŹźŻż_\s-]+(,[A-Za-z0-9ĄąĆćĘęŁłŃńÓóŚśŹźŻż_\s-]+)*)?$/.test(dependencies.value)) {
                showCustomValidationError(dependencies, 'Dependencies must be comma-separated process names (including Polish characters)');
                return false;
            }
            
            return true;
        }
        
        function showCustomValidationError(element, message) {
            element.focus();
            element.setCustomValidity(message);
            element.reportValidity();
            
            // Clear custom validity after user starts typing
            element.addEventListener('input', function clearCustomValidity() {
                element.setCustomValidity('');
                element.removeEventListener('input', clearCustomValidity);
            });
        }
        
        // Process type helper functions
        function getProcessTypeAbbreviation(type) {
            const abbreviations = {
                'standard': 'S',
                'blocking': 'B',
                'informational': 'I'
            };
            return abbreviations[type] || 'S';
        }
        
        function getProcessTypeFullName(type) {
            const fullNames = {
                'standard': 'Standard',
                'blocking': 'Blocking',
                'informational': 'Informational'
            };
            return fullNames[type] || 'Standard';
        }
        
        function toggleProcessType(element) {
            const processId = element.dataset.processId;
            const currentType = element.dataset.type;
            
            const types = ['standard', 'blocking', 'informational'];
            const currentIndex = types.indexOf(currentType);
            const nextIndex = (currentIndex + 1) % types.length;
            const nextType = types[nextIndex];
            
            // Update the display
            element.dataset.type = nextType;
            const abbreviationSpan = element.querySelector('.type-abbreviation');
            abbreviationSpan.textContent = getProcessTypeAbbreviation(nextType);
            abbreviationSpan.title = getProcessTypeFullName(nextType);
            
            // Update the database
            updateProcessType(processId, nextType);
        }
        
        async function updateProcessType(processId, newType) {
            try {
                const { error } = await supabaseClient
                    .from('processes')
                    .update({ process_type: newType })
                    .eq('id', processId);

                if (error) {
                    showNotification('Error updating process type', 'error');
                    console.error('Error:', error);
                } else {
                    showNotification(`Process type updated to ${getProcessTypeFullName(newType)}`, 'success');
                }
            } catch (error) {
                showNotification('Error updating process type', 'error');
                console.error('Error:', error);
            }
        }

        // Dependencies modal functions
        let currentProcessId = null;
        let currentDependencies = [];
        
        async function openDependenciesModal(processId, currentDeps) {
            currentProcessId = processId;
            currentDependencies = currentDeps ? currentDeps.split(',').map(d => d.trim()).filter(d => d) : [];
            
            // Get all processes in current sheet except the current one
            const { data: processes, error } = await supabaseClient
                .from('processes')
                .select('id, short_name')
                .eq('sheet_id', currentSheet.id)
                .neq('id', processId)
                .order('short_name');
                
            if (error) {
                showNotification('Error loading processes', 'error');
                return;
            }
            
            showDependenciesModal(processes);
        }
        
        function showDependenciesModal(processes) {
            const modal = document.createElement('div');
            modal.className = 'dependencies-modal';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeDependenciesModal();
                }
            };
            
            const content = document.createElement('div');
            content.className = 'dependencies-modal-content';
            
            content.innerHTML = `
                <h3>Select Dependencies</h3>
                <div class="dependencies-list">
                    ${processes.map(process => `
                        <div class="dependency-item">
                            <input type="checkbox" id="dep-${process.id}" class="dependency-checkbox" 
                                   value="${process.short_name}" 
                                   ${currentDependencies.includes(process.short_name) ? 'checked' : ''}>
                            <label for="dep-${process.id}" class="dependency-label">${process.short_name}</label>
                        </div>
                    `).join('')}
                </div>
                <div class="dependencies-modal-buttons">
                    <button onclick="closeDependenciesModal()">Cancel</button>
                    <button class="btn-primary" onclick="saveDependencies()">Save</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Add keyboard support
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDependenciesModal();
                }
            });
        }
        
        function closeDependenciesModal() {
            const modal = document.querySelector('.dependencies-modal');
            if (modal) {
                modal.remove();
            }
            isFromEditModal = false; // Reset flag
        }
        
        // Flag to track if dependencies modal was opened from edit modal
        let isFromEditModal = false;
        
        async function openDependenciesModalFromEdit() {
            if (!editingProcess && !currentSheet) {
                showNotification('No process or sheet context available', 'error');
                return;
            }
            
            isFromEditModal = true;
            const processId = editingProcess ? editingProcess.id : 'new';
            const currentDeps = document.getElementById('process-dependencies').value;
            
            // Get all processes in current sheet except the current one (if editing)
            let query = supabaseClient
                .from('processes')
                .select('id, short_name')
                .eq('sheet_id', currentSheet.id)
                .order('short_name');
                
            if (editingProcess) {
                query = query.neq('id', editingProcess.id);
            }
            
            const { data: processes, error } = await query;
                
            if (error) {
                showNotification('Error loading processes', 'error');
                return;
            }
            
            currentProcessId = processId;
            currentDependencies = currentDeps ? currentDeps.split(',').map(d => d.trim()).filter(d => d) : [];
            showDependenciesModal(processes);
        }
        
        async function saveDependencies() {
            const checkboxes = document.querySelectorAll('.dependency-checkbox:checked');
            const selectedDependencies = Array.from(checkboxes).map(cb => cb.value);
            const dependenciesString = selectedDependencies.join(', ');
            
            if (isFromEditModal) {
                // Update the input field in edit modal
                document.getElementById('process-dependencies').value = dependenciesString;
                isFromEditModal = false;
                closeDependenciesModal();
                showNotification('Dependencies selected', 'success');
            } else {
                // Update in database directly (from table)
                try {
                    const { error } = await supabaseClient
                        .from('processes')
                        .update({ dependencies: dependenciesString })
                        .eq('id', currentProcessId);

                    if (error) {
                        showNotification('Error updating dependencies', 'error');
                        console.error('Error:', error);
                    } else {
                        showNotification('Dependencies updated successfully', 'success');
                        loadProcesses(); // Refresh table
                        closeDependenciesModal();
                    }
                } catch (error) {
                    showNotification('Error updating dependencies', 'error');
                    console.error('Error:', error);
                }
            }
        }

        async function editProcess(processId) {
            const { data: processData, error } = await supabaseClient
                .from('processes')
                .select('*')
                .eq('id', processId)
                .limit(1);

            if (error || !processData || processData.length === 0) {
                showNotification('Error loading process', 'error');
                return;
            }
            
            const process = processData[0];

            editingProcess = process;
            openProcessModal();
        }

        async function deleteProcess(processId) {
            if (!confirm('Are you sure you want to delete this process?')) return;

            const { error } = await supabaseClient
                .from('processes')
                .delete()
                .eq('id', processId);

            if (error) {
                showNotification('Error deleting process', 'error');
                console.error('Error:', error);
            } else {
                showNotification('Process deleted', 'success');
                loadProcesses();
            }
        }

        // Column Management Functions
        function openColumnsModal() {
            if (!currentSheet) return;
            
            // Reset column changes
            columnChanges = {
                toAdd: [],
                toDelete: [],
                toRename: []
            };
            
            renderExistingColumns();
            document.getElementById('new-column-name').value = '';
            document.getElementById('columns-modal').classList.add('active');
        }

        function renderExistingColumns() {
            const container = document.getElementById('existing-columns-list');
            const customFields = currentSheet.custom_fields || {};
            
            if (Object.keys(customFields).length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No custom columns yet. Add some below!</p>';
                return;
            }
            
            container.innerHTML = '';
            
            Object.keys(customFields).forEach(fieldName => {
                const columnItem = createColumnItem(fieldName, 'existing');
                container.appendChild(columnItem);
            });
        }

        function createColumnItem(fieldName, type = 'existing') {
            const columnItem = document.createElement('div');
            columnItem.className = `column-item ${type === 'new' ? 'pending-add' : ''}`;
            columnItem.dataset.originalName = fieldName;
            
            columnItem.innerHTML = `
                <input type="text" value="${fieldName}" ${type === 'existing' ? 'onblur="handleColumnRename(this)"' : ''} 
                       placeholder="Column name">
                <button type="button" class="btn btn-secondary btn-small" onclick="markColumnForDeletion(this)">Remove</button>
            `;
            
            return columnItem;
        }

        function addNewColumn() {
            const input = document.getElementById('new-column-name');
            const columnName = input.value.trim();
            
            if (!columnName) {
                showNotification('Please enter a column name', 'warning');
                return;
            }
            
            // Check if column already exists
            const existingFields = currentSheet.custom_fields || {};
            if (existingFields[columnName]) {
                showNotification('Column with this name already exists', 'warning');
                return;
            }
            
            // Check if already in pending additions
            if (columnChanges.toAdd.includes(columnName)) {
                showNotification('Column already added to pending changes', 'warning');
                return;
            }
            
            // Add to pending changes
            columnChanges.toAdd.push(columnName);
            
            // Add visual indicator
            const container = document.getElementById('existing-columns-list');
            if (container.textContent.includes('No custom columns yet')) {
                container.innerHTML = '';
            }
            
            const columnItem = createColumnItem(columnName, 'new');
            container.appendChild(columnItem);
            
            input.value = '';
            showNotification(`Column "${columnName}" added to pending changes`, 'info');
        }

        function handleColumnRename(input) {
            const originalName = input.closest('.column-item').dataset.originalName;
            const newName = input.value.trim();
            
            if (!newName) {
                input.value = originalName;
                showNotification('Column name cannot be empty', 'warning');
                return;
            }
            
            if (newName === originalName) {
                // No change
                input.closest('.column-item').classList.remove('pending-rename');
                return;
            }
            
            // Check if new name conflicts with existing fields
            const existingFields = currentSheet.custom_fields || {};
            if (existingFields[newName] && newName !== originalName) {
                input.value = originalName;
                showNotification('Column with this name already exists', 'warning');
                return;
            }
            
            // Add to rename changes
            const existingRename = columnChanges.toRename.find(r => r.oldName === originalName);
            if (existingRename) {
                existingRename.newName = newName;
            } else {
                columnChanges.toRename.push({ oldName: originalName, newName: newName });
            }
            
            input.closest('.column-item').classList.add('pending-rename');
            showNotification(`Column will be renamed from "${originalName}" to "${newName}"`, 'info');
        }

        function markColumnForDeletion(button) {
            const columnItem = button.closest('.column-item');
            const columnName = columnItem.dataset.originalName;
            
            if (columnItem.classList.contains('pending-add')) {
                // Remove from pending additions
                const index = columnChanges.toAdd.indexOf(columnName);
                if (index > -1) {
                    columnChanges.toAdd.splice(index, 1);
                }
                columnItem.remove();
                
                // Check if no columns left
                const container = document.getElementById('existing-columns-list');
                if (!container.children.length) {
                    container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">No custom columns yet. Add some below!</p>';
                }
                
                showNotification(`Pending column "${columnName}" removed`, 'info');
                return;
            }
            
            if (columnItem.classList.contains('pending-delete')) {
                // Restore column
                const index = columnChanges.toDelete.indexOf(columnName);
                if (index > -1) {
                    columnChanges.toDelete.splice(index, 1);
                }
                columnItem.classList.remove('pending-delete');
                button.textContent = 'Remove';
                button.style.backgroundColor = '';
                showNotification(`Column "${columnName}" restored`, 'info');
            } else {
                // Mark for deletion
                if (!columnChanges.toDelete.includes(columnName)) {
                    columnChanges.toDelete.push(columnName);
                }
                columnItem.classList.add('pending-delete');
                button.textContent = 'Restore';
                button.style.backgroundColor = '#e74c3c';
                showNotification(`Column "${columnName}" marked for deletion`, 'warning');
            }
        }

        async function saveColumnChanges() {
            if (columnChanges.toAdd.length === 0 && 
                columnChanges.toDelete.length === 0 && 
                columnChanges.toRename.length === 0) {
                showNotification('No changes to save', 'info');
                closeModals();
                return;
            }

            try {
                // Create new custom_fields object
                const newCustomFields = { ...currentSheet.custom_fields || {} };
                
                // Handle deletions
                columnChanges.toDelete.forEach(fieldName => {
                    delete newCustomFields[fieldName];
                });
                
                // Handle renames
                columnChanges.toRename.forEach(rename => {
                    if (newCustomFields[rename.oldName]) {
                        newCustomFields[rename.newName] = newCustomFields[rename.oldName];
                        delete newCustomFields[rename.oldName];
                    }
                });
                
                // Handle additions
                columnChanges.toAdd.forEach(fieldName => {
                    newCustomFields[fieldName] = 'text'; // default type
                });

                // Update sheet in Supabase
                const { error } = await supabaseClient
                    .from('sheets')
                    .update({ custom_fields: newCustomFields })
                    .eq('id', currentSheet.id);

                if (error) {
                    showNotification('Error updating columns', 'error');
                    console.error('Error:', error);
                    return;
                }

                // Update current sheet data
                currentSheet.custom_fields = newCustomFields;

                // Handle process data updates for deletions and renames
                if (columnChanges.toDelete.length > 0 || columnChanges.toRename.length > 0) {
                    await updateProcessCustomData();
                }

                showNotification('Columns updated successfully!', 'success');
                closeModals();
                loadProcesses(); // Reload the table with new columns
                
            } catch (error) {
                showNotification('Error updating columns', 'error');
                console.error('Error:', error);
            }
        }

        async function updateProcessCustomData() {
            try {
                // Get all processes for this sheet
                const { data: processes, error } = await supabaseClient
                    .from('processes')
                    .select('*')
                    .eq('sheet_id', currentSheet.id);

                if (error) {
                    console.error('Error fetching processes:', error);
                    return;
                }

                // Update each process
                for (const process of processes) {
                    let customData = { ...process.custom_data || {} };
                    let hasChanges = false;

                    // Handle deletions
                    columnChanges.toDelete.forEach(fieldName => {
                        if (customData[fieldName] !== undefined) {
                            delete customData[fieldName];
                            hasChanges = true;
                        }
                    });

                    // Handle renames
                    columnChanges.toRename.forEach(rename => {
                        if (customData[rename.oldName] !== undefined) {
                            customData[rename.newName] = customData[rename.oldName];
                            delete customData[rename.oldName];
                            hasChanges = true;
                        }
                    });

                    // Update process if there are changes
                    if (hasChanges) {
                        await supabaseClient
                            .from('processes')
                            .update({ custom_data: customData })
                            .eq('id', process.id);
                    }
                }
            } catch (error) {
                console.error('Error updating process custom data:', error);
            }
        }

        // Real-time validation
        function setupFormValidation() {
            // Add real-time validation to all forms
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('input', function(e) {
                    if (e.target.validity.valid) {
                        e.target.style.borderColor = 'var(--fc-neon-success)';
                        e.target.style.boxShadow = '0 0 10px rgba(57, 255, 20, 0.3)';
                    } else if (e.target.value.length > 0) {
                        e.target.style.borderColor = 'var(--fc-neon-secondary)';
                        e.target.style.boxShadow = '0 0 10px rgba(255, 0, 110, 0.3)';
                    } else {
                        e.target.style.borderColor = 'var(--fc-border)';
                        e.target.style.boxShadow = 'none';
                    }
                });

                form.addEventListener('invalid', function(e) {
                    e.preventDefault();
                    window.FlowCraftErrorHandler.showNotification(
                        e.target.validationMessage || 'Please check your input',
                        'validation'
                    );
                }, true);
            });

            // Custom validation for working day field
            const workingDayField = document.getElementById('process-working-day');
            if (workingDayField) {
                workingDayField.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    if (value === 0) {
                        this.setCustomValidity('Working day cannot be 0');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }
        }

        // Event Listeners
        document.getElementById('login-form-element').addEventListener('submit', handleLogin);
        document.getElementById('register-form-element').addEventListener('submit', handleRegister);
        document.getElementById('show-register').addEventListener('click', () => {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        });
        document.getElementById('show-login').addEventListener('click', () => {
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        });

        // Add forgot password handler
        document.getElementById('forgot-password').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            
            if (!email) {
                showNotification('Please enter your email address first', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/reset.html`
                });

                if (error) {
                    if (error.message.includes('rate limit')) {
                        showNotification('Please wait a minute before requesting another password reset email', 'warning');
                    } else {
                        showNotification(error.message, 'error');
                    }
                } else {
                    showNotification('Password reset instructions have been sent to your email', 'success');
                }
            } catch (err) {
                showNotification('An error occurred while processing your request', 'error');
                console.error('Password reset error:', err);
            }
        });

        // =====================================================
        // PROJECT MEMBERS MANAGEMENT FUNCTIONS
        // =====================================================

        // Open invite member modal
        function openInviteMemberModal() {
            document.getElementById('invite-member-modal').classList.add('active');
            document.getElementById('invite-email').focus();
        }

        // Handle invite member form submission
        async function handleInviteMember(e) {
            e.preventDefault();
            
            const email = document.getElementById('invite-email').value;
            const role = document.getElementById('invite-role').value;
            const message = document.getElementById('invite-message').value;
            
            if (!currentProject) {
                showNotification('No project selected', 'error');
                return;
            }
            
            try {
                // Check user invitation status (includes cleanup of expired invitations)
                const userStatus = await window.FlowCraftErrorHandler.checkUserInvitationStatus(currentProject.id, email);
                
                if (userStatus.status === 'MEMBER') {
                    showNotification(`${email} is already a member of this project.`, 'info');
                    return;
                }
                
                if (userStatus.status === 'PENDING') {
                    const confirmResend = confirm(`There's already a pending invitation for ${email}. Do you want to send a new invitation?`);
                    if (!confirmResend) {
                        return;
                    }
                } else if (userStatus.status === 'EXPIRED' || userStatus.status === 'REVOKED') {
                    // Allow sending new invitation for expired/revoked ones
                    console.log(`Previous invitation was ${userStatus.status}, sending new one...`);
                } else if (userStatus.status === 'ACCEPTED') {
                    showNotification(`${email} has already accepted an invitation but may not be a full member yet.`, 'info');
                    return;
                }
                
                // Send the new invitation with custom message
                const result = await window.FlowCraftErrorHandler.inviteUserToProject(
                    currentProject.id, 
                    email, 
                    role,
                    message
                );
                
                if (result.data) {
                    if (result.emailSent) {
                        showNotification(`Invitation sent to ${email}`, 'success');
                    } else {
                        showNotification(`Invitation created for ${email}, but email delivery failed. They can still accept via direct link.`, 'warning');
                        console.warn('Email delivery failed:', result.emailError);
                    }
                    closeModals();
                    document.getElementById('invite-member-form').reset();
                    loadProjectMembers(); // Refresh the members list
                } else {
                    showNotification('Failed to create invitation', 'error');
                }
            } catch (error) {
                let errorMessage = error.message;
                
                // Handle specific error cases
                if (error.message.includes('duplicate key value violates unique constraint')) {
                    errorMessage = `Unexpected database constraint error. This should not happen with the new invitation system. Please try again or contact support.`;
                } else if (error.message.includes('already a member')) {
                    errorMessage = `This user is already a member of this project.`;
                } else if (error.message.includes('Invalid email')) {
                    errorMessage = 'Please enter a valid email address.';
                } else if (error.message.includes('Email service not configured')) {
                    errorMessage = 'Email service is not configured. The invitation has been created but no email was sent.';
                    // Don't show as error if invitation was created successfully
                    showNotification('Invitation created (email service not configured)', 'warning');
                    closeModals();
                    document.getElementById('invite-member-form').reset();
                    loadProjectMembers();
                    return;
                }
                
                showNotification(errorMessage, 'error');
                console.error('Invitation error:', error);
            }
        }

        // Load project members
        async function loadProjectMembers() {
            if (!currentProject) return;
            
            try {
                // Check if user has access to manage members (with better error handling)
                let access = { hasAccess: true, isOwner: true, role: 'OWNER' }; // Default to owner access
                
                try {
                    access = await window.FlowCraftErrorHandler.checkProjectAccess(currentProject.id);
                } catch (accessError) {
                    console.warn('Could not check project access, assuming owner access:', accessError);
                    // Continue with default owner access
                }
                
                // Hide Project Members section for shared projects (user is not owner)
                // Check if user is not the owner of the project  
                console.log('=== PROJECT MEMBERS DEBUG ===');
                console.log('currentProject.user_id:', currentProject.user_id);
                console.log('currentUser.id:', currentUser.id);
                console.log('access:', access);
                
                // Show Project Members section for:
                // 1. Project owners (currentProject.user_id === currentUser.id)
                // 2. Users with FULL_ACCESS role (they can manage invitations)
                const isOwner = currentProject.user_id === currentUser.id;
                const hasFullAccess = access.role === 'FULL_ACCESS';
                
                if (!isOwner && !hasFullAccess) {
                    console.log('Hiding Project Members: not owner and no full access');
                    document.getElementById('project-members-section').style.display = 'none';
                    return;
                } else {
                    console.log('Showing Project Members: isOwner=', isOwner, 'hasFullAccess=', hasFullAccess);
                    document.getElementById('project-members-section').style.display = 'block';
                }
                
                if (!access.hasAccess && !access.isOwner) {
                    document.getElementById('project-members-section').style.display = 'none';
                    return;
                }
                
                // Show/hide invite button based on permissions
                const inviteBtn = document.getElementById('invite-member-btn');
                if (access.isOwner || access.role === 'FULL_ACCESS') {
                    inviteBtn.style.display = 'block';
                } else {
                    inviteBtn.style.display = 'none';
                }
                
                // Load members (with error handling for missing tables)
                let membersResult = { data: [] };
                let invitationsResult = { data: [] };
                
                try {
                    membersResult = await window.FlowCraftErrorHandler.getProjectMembers(currentProject.id);
                } catch (membersError) {
                    console.warn('Could not load project members (table may not exist):', membersError);
                }
                
                try {
                    invitationsResult = await window.FlowCraftErrorHandler.getProjectInvitations(currentProject.id);
                } catch (invitationsError) {
                    console.warn('Could not load project invitations (table may not exist):', invitationsError);
                }
                
                renderProjectMembers(membersResult.data || [], access);
                renderProjectInvitations(invitationsResult.data || [], access);
                
            } catch (error) {
                console.error('Error loading project members:', error);
                // Don't show notification for missing tables - just continue
                document.getElementById('project-members-section').style.display = 'none';
            }
        }

        // Render project members
        function renderProjectMembers(members, access) {
            const membersGrid = document.getElementById('members-grid');
            
            if (members.length === 0) {
                membersGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <p>No members yet. Start by inviting team members to collaborate.</p>
                    </div>
                `;
                return;
            }
            
            // Add project owner to the list
            const ownerMember = {
                user: { email: currentProject.user_email || 'Project Owner' },
                role: 'OWNER',
                joined_at: currentProject.created_at
            };
            
            const allMembers = [ownerMember, ...members];
            
            membersGrid.innerHTML = allMembers.map(member => `
                <div class="member-card">
                    <div class="member-info">
                        <div class="member-email">${member.user?.email || 'Unknown'}</div>
                        <div class="member-role ${member.role.toLowerCase().replace('_', '-')}">${member.role.replace('_', ' ')}</div>
                    </div>
                    <div class="member-actions">
                        ${(access.isOwner && member.role !== 'OWNER') ? `
                            <div class="role-dropdown">
                                <button class="btn-role-change" onclick="toggleRoleDropdown(this)">Change Role</button>
                                <div class="role-dropdown-content">
                                    <div class="role-dropdown-item" onclick="changeRole('${member.user_id}', 'FULL_ACCESS')">Full Access</div>
                                    <div class="role-dropdown-item" onclick="changeRole('${member.user_id}', 'EDIT_ACCESS')">Edit Access</div>
                                    <div class="role-dropdown-item" onclick="changeRole('${member.user_id}', 'VIEW_ONLY')">View Only</div>
                                </div>
                            </div>
                            <button class="btn-remove-member" onclick="removeMember('${member.user_id}', '${member.user?.email}')">Remove</button>
                        ` : ''}
                    </div>
                    <div class="member-joined">Joined: ${new Date(member.joined_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        // Render project invitations
        function renderProjectInvitations(invitations, access) {
            const invitationsGrid = document.getElementById('invitations-grid');
            const invitationsContainer = document.getElementById('invitations-container');
            
            if (invitations.length === 0) {
                invitationsContainer.style.display = 'none';
                return;
            }
            
            invitationsContainer.style.display = 'block';
            
            invitationsGrid.innerHTML = invitations.map(invitation => `
                <div class="invitation-card">
                    <div class="invitation-info">
                        <div class="invitation-email">${invitation.email}</div>
                        <div class="invitation-role ${invitation.role.toLowerCase().replace('_', '-')}">${invitation.role.replace('_', ' ')}</div>
                        <div class="invitation-status ${invitation.status.toLowerCase()}">${invitation.status}</div>
                    </div>
                    <div class="invitation-actions">
                        ${(access.isOwner || access.role === 'FULL_ACCESS') ? `
                            <button class="btn-remove-member" onclick="revokeInvitation('${invitation.id}', '${invitation.email}')">Revoke</button>
                        ` : ''}
                    </div>
                    <div class="invitation-created">Invited: ${new Date(invitation.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        // Toggle role dropdown
        function toggleRoleDropdown(button) {
            const dropdown = button.nextElementSibling;
            dropdown.classList.toggle('show');
            
            // Close other dropdowns
            document.querySelectorAll('.role-dropdown-content').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
        }

        // Change member role
        async function changeRole(userId, newRole) {
            try {
                const result = await window.FlowCraftErrorHandler.updateMemberRole(
                    currentProject.id, 
                    userId, 
                    newRole
                );
                
                // Check for error first, then success
                if (result.error) {
                    throw new Error(result.error.message);
                }
                
                // Update operation succeeded - always reload members
                showNotification(`Role updated to ${newRole.replace('_', ' ')}`, 'success');
                loadProjectMembers();
                
            } catch (error) {
                showNotification(error.message || 'Failed to update role', 'error');
                console.error('Role change error:', error);
            }
            
            // Close dropdown
            document.querySelectorAll('.role-dropdown-content').forEach(d => {
                d.classList.remove('show');
            });
        }

        // Remove member
        async function removeMember(userId, email) {
            if (!confirm(`Are you sure you want to remove ${email} from this project?`)) {
                return;
            }
            
            try {
                const result = await window.FlowCraftErrorHandler.removeProjectMember(
                    currentProject.id, 
                    userId
                );
                
                // Check for error first, then success
                if (result.error) {
                    throw new Error(result.error.message);
                }
                
                // Delete operation succeeded - always reload members
                showNotification(`${email} has been removed from the project`, 'success');
                loadProjectMembers();
                
            } catch (error) {
                showNotification(error.message || 'Failed to remove member', 'error');
                console.error('Remove member error:', error);
            }
        }

        // Revoke invitation
        async function revokeInvitation(invitationId, email) {
            if (!confirm(`Are you sure you want to revoke the invitation for ${email}?`)) {
                return;
            }
            
            try {
                const result = await window.FlowCraftErrorHandler.executeSupabaseRequest(
                    () => supabaseClient.rpc('revoke_invitation', { invitation_id: invitationId }),
                    { loadingMessage: 'Revoking invitation...' }
                );
                
                // Check for error first, then success
                if (result.error) {
                    throw new Error(result.error.message);
                }
                
                // Update operation succeeded - always reload members
                showNotification(`Invitation for ${email} has been revoked`, 'success');
                loadProjectMembers();
                
            } catch (error) {
                showNotification(error.message || 'Failed to revoke invitation', 'error');
                console.error('Revoke invitation error:', error);
            }
        }

        // Close role dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.matches('.btn-role-change')) {
                document.querySelectorAll('.role-dropdown-content').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });

        // Initialize date selectors
        function initializeDateSelectors() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            // Populate year selector (current year and next 2 years)
            const yearSelect = document.getElementById('target-year-select');
            yearSelect.innerHTML = '';
            for (let year = currentYear - 1; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            // Set current month
            document.getElementById('target-month-select').value = currentMonth;
            
            // Add event listeners for automatic updates
            document.getElementById('target-month-select').addEventListener('change', autoUpdateDatesOnChange);
            document.getElementById('target-year-select').addEventListener('change', autoUpdateDatesOnChange);
        }

        // Auto-update dates when month/year changes
        async function autoUpdateDatesOnChange() {
            if (currentSheet) {
                await updateProcessDates();
            }
        }

        // Update process due dates
        async function updateProcessDates() {
            if (!currentSheet) {
                showNotification('No workflow selected', 'error');
                return;
            }

            try {
                const targetMonth = parseInt(document.getElementById('target-month-select').value);
                const targetYear = parseInt(document.getElementById('target-year-select').value);
                
                showNotification(`Updating process dates for ${getMonthName(targetMonth)} ${targetYear}...`, 'info');
                
                const result = await window.FlowCraftErrorHandler.updateProcessDueDates(
                    currentSheet.id, 
                    targetYear, 
                    targetMonth
                );
                
                if (result.message) {
                    showNotification(result.message, 'success');
                    // Reload processes to show updated dates
                    loadProcesses(currentSheet.id);
                } else {
                    showNotification('Failed to update dates', 'error');
                }
            } catch (error) {
                showNotification(error.message || 'Failed to update process dates', 'error');
                console.error('Date update error:', error);
            }
        }

        // Helper function to get month name
        function getMonthName(monthNumber) {
            const months = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[monthNumber];
        }

        // Handle invitation token from URL
        async function handleInvitationToken(invitationToken) {
            try {
                showNotification('Processing invitation...', 'info');
                
                const result = await window.FlowCraftErrorHandler.acceptInvitation(invitationToken);
                
                if (result.data) {
                    showNotification('Invitation accepted successfully! Welcome to the project.', 'success');
                    
                    // Clear the invitation token from URL
                    const url = new URL(window.location);
                    url.searchParams.delete('invitation');
                    window.history.replaceState({}, '', url);
                    
                    // Load projects to show the new project
                    loadProjects();
                } else {
                    showNotification('Failed to accept invitation. Please try again.', 'error');
                }
            } catch (error) {
                let errorMessage = 'Error accepting invitation';
                
                if (error.message.includes('expired')) {
                    errorMessage = 'Invitation has expired. Please request a new one.';
                } else if (error.message.includes('already accepted')) {
                    errorMessage = 'You are already a member of this project.';
                } else if (error.message.includes('Invalid or expired')) {
                    errorMessage = 'Invalid or expired invitation link.';
                }
                
                showNotification(errorMessage, 'error');
                console.error('Invitation error:', error);
            }
        }

        // Modify existing showSheetsView function to load members
        const originalShowSheetsView = showSheetsView;
        showSheetsView = function(project) {
            const result = originalShowSheetsView(project);
            // Load members after showing sheets view
            setTimeout(() => {
                loadProjectMembers();
            }, 100);
            return result;
        };

        // =====================================================
        // DEBUG AND CLEANUP FUNCTIONS
        // =====================================================

        // Debug function to clean up duplicate invitations
        window.debugCleanupInvitations = async function(projectId = null) {
            if (!projectId && !currentProject) {
                console.error('No project selected. Use debugCleanupInvitations(projectId) or select a project first.');
                return;
            }
            
            const pid = projectId || currentProject.id;
            
            try {
                // Get all invitations for the project
                const invitations = await window.FlowCraftErrorHandler.getProjectInvitations(pid);
                console.log('Current invitations:', invitations.data);
                
                // Group by email
                const emailGroups = {};
                invitations.data.forEach(inv => {
                    if (!emailGroups[inv.email]) {
                        emailGroups[inv.email] = [];
                    }
                    emailGroups[inv.email].push(inv);
                });
                
                // Find duplicates
                const duplicates = Object.entries(emailGroups).filter(([email, invs]) => invs.length > 1);
                
                if (duplicates.length === 0) {
                    console.log('No duplicate invitations found.');
                    return;
                }
                
                console.log('Found duplicate invitations:', duplicates);
                
                // Clean up duplicates (keep the newest, revoke the older ones)
                for (const [email, invs] of duplicates) {
                    // Sort by created_at descending (newest first)
                    invs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    // Revoke all but the first (newest)
                    for (let i = 1; i < invs.length; i++) {
                        const inv = invs[i];
                        console.log(`Revoking old invitation for ${email}:`, inv.id);
                        
                        await window.FlowCraftErrorHandler.executeSupabaseRequest(
                            () => window.supabaseClient
                                .from('project_invitations')
                                .update({ status: 'REVOKED' })
                                .eq('id', inv.id),
                            { loadingMessage: false }
                        );
                    }
                }
                
                console.log('Cleanup completed. Refreshing member list...');
                if (currentProject && currentProject.id === pid) {
                    loadProjectMembers();
                }
                
            } catch (error) {
                console.error('Error during cleanup:', error);
            }
        };

        // =====================================================
        // PROCESS STATUS MANAGEMENT FUNCTIONS (moved from Diagram.html)
        // =====================================================

        // Open process status modal
        function openProcessStatusModal(processId) {
            // Find process data
            const processData = currentProcesses.find(p => p.id === processId);
            if (!processData) {
                showNotification('Process not found', 'error');
                return;
            }

            // Remove existing modal if any
            const existingModal = document.getElementById('process-status-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'process-status-modal';
            modal.className = 'process-status-modal';

            const modalContent = document.createElement('div');
            modalContent.className = 'process-status-modal-content';

            const currentStatus = processData.status || 'PENDING';
            const isDueDatePassed = processData.due_date && new Date(processData.due_date) < new Date();

            modalContent.innerHTML = `
                <h3>Manage Process Status</h3>
                <div style="margin-bottom: 16px;">
                    <strong>Process:</strong> ${processData.short_name} (${processData.id})<br>
                    <strong>Current Status:</strong> ${currentStatus.replace('_', ' ')}<br>
                    <strong>Due Date:</strong> ${processData.due_date || 'Not set'}<br>
                    ${processData.assigned_to_email ? `<strong>Assigned to:</strong> ${processData.assigned_to_email}<br>` : ''}
                </div>
                
                <div class="status-actions">
                    <button class="status-action-btn completed" onclick="updateProcessStatus('${processData.id}', 'COMPLETED_ON_TIME')">
                        ✓ Mark as Completed On Time
                    </button>
                    <button class="status-action-btn completed" onclick="updateProcessStatus('${processData.id}', 'COMPLETED_LATE')">
                        ✓ Mark as Completed Late
                    </button>
                    <button class="status-action-btn delayed" onclick="toggleDelayedForm('${processData.id}')">
                        ⏱ Mark as Delayed with Reason
                    </button>
                    ${currentStatus !== 'PENDING' ? `
                        <button class="status-action-btn" onclick="updateProcessStatus('${processData.id}', 'PENDING')">
                            ○ Reset to Pending
                        </button>
                    ` : ''}
                </div>
                
                <div id="delayed-form" style="display: none; margin-top: 16px;">
                    <label for="delay-reason">Reason for delay:</label>
                    <textarea id="delay-reason" class="status-note-input" placeholder="Please provide a reason for the delay..."></textarea>
                    <div style="margin-top: 12px;">
                        <button class="status-action-btn delayed" onclick="updateProcessStatus('${processData.id}', 'DELAYED_WITH_REASON', document.getElementById('delay-reason').value)">
                            Save Delay Reason
                        </button>
                        <button class="status-action-btn" onclick="toggleDelayedForm('${processData.id}')">
                            Cancel
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn-fc btn-fc-secondary" onclick="closeProcessStatusModal()">Close</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeProcessStatusModal();
                }
            });

            // Focus on modal
            modal.style.display = 'flex';
        }

        // Close process status modal
        function closeProcessStatusModal() {
            const modal = document.getElementById('process-status-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Toggle delayed form
        function toggleDelayedForm(processId) {
            const form = document.getElementById('delayed-form');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
                if (form.style.display === 'block') {
                    document.getElementById('delay-reason').focus();
                }
            }
        }

        // Update process status
        async function updateProcessStatus(processId, newStatus, note = '') {
            try {
                const completedLate = newStatus === 'COMPLETED_LATE';
                
                let result;
                if (newStatus === 'COMPLETED_ON_TIME' || newStatus === 'COMPLETED_LATE') {
                    result = await window.FlowCraftErrorHandler.markProcessCompleted(processId, note, completedLate);
                } else if (newStatus === 'DELAYED_WITH_REASON') {
                    if (!note.trim()) {
                        showNotification('Please provide a reason for the delay', 'error');
                        return;
                    }
                    result = await window.FlowCraftErrorHandler.markProcessDelayed(processId, note);
                } else {
                    // Reset to pending or other status - with enhanced error handling
                    try {
                        // Prepare update fields for reset status
                        const updateFields = {
                            status: newStatus,
                            completed_at: null,
                            completion_note: null,
                            updated_at: new Date().toISOString()
                        };
                        
                        result = await window.FlowCraftErrorHandler.executeSupabaseRequest(
                            () => window.supabaseClient
                                .from('processes')
                                .update(updateFields)
                                .eq('id', processId)
                                .select(),
                            { loadingMessage: 'Resetting status...' }
                        );
                    } catch (statusUpdateError) {
                        console.warn('Status update failed, trying minimal update:', statusUpdateError);
                        // Fallback: try updating only basic fields if status fields don't exist
                        result = await window.FlowCraftErrorHandler.executeSupabaseRequest(
                            () => window.supabaseClient
                                .from('processes')
                                .update({
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', processId)
                                .select(),
                            { loadingMessage: 'Updating process...' }
                        );
                        
                        // If even that fails, throw the original error
                        if (!result?.data?.length) {
                            throw statusUpdateError;
                        }
                        
                        showNotification('Status reset completed (limited database support)', 'warning');
                        // Still proceed with synchronization
                    }
                }

                if (result?.data?.length > 0 || result?.data) {
                    showNotification(`Process status updated to ${newStatus.replace('_', ' ')}`, 'success');
                    closeProcessStatusModal();
                    
                    // Update the process data in memory
                    const process = currentProcesses.find(p => p.id === processId);
                    if (process) {
                        process.status = newStatus;
                        process.completion_note = note;
                        if (newStatus.includes('COMPLETED')) {
                            process.completed_at = new Date().toISOString();
                        } else if (newStatus === 'PENDING') {
                            process.completed_at = null;
                            process.completion_note = null;
                        }
                    }
                    
                    // Notify any open diagram windows of the status change
                    try {
                        if (window.opener && !window.opener.closed) {
                            window.opener.postMessage({
                                type: 'PROCESS_STATUS_UPDATED',
                                processId: processId,
                                newStatus: newStatus,
                                completionNote: newStatus === 'PENDING' ? null : note
                            }, window.location.origin);
                            console.log(`PostMessage sent to diagram: ${processId} -> ${newStatus}`);
                        } else {
                            console.warn('No diagram window found to notify (window.opener not available)');
                        }
                    } catch (messageError) {
                        console.warn('Could not notify diagram window:', messageError);
                    }
                    
                    // Re-render the processes table
                    loadProcesses();
                } else {
                    console.error('Update result:', result);
                    showNotification('Failed to update process status - check console for details', 'error');
                }
            } catch (error) {
                showNotification(error.message, 'error');
                console.error('Status update error:', error);
            }
        }

        // Keyboard shortcut for ESC to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProcessStatusModal();
            }
        });

        // =====================================================
        // DELETE FUNCTIONS
        // =====================================================

        // Delete project with confirmation
        async function deleteProject(projectId, projectName) {
            if (!confirm(`Are you sure you want to delete project "${projectName}"?\n\nThis action cannot be undone and will delete all workflows and processes in this project.`)) {
                return;
            }

            try {
                const result = await window.FlowCraftErrorHandler.executeSupabaseRequest(
                    () => supabaseClient
                        .from('projects')
                        .delete()
                        .eq('id', projectId)
                        .eq('user_id', currentUser.id), // Ensure user can only delete their own projects
                    { loadingMessage: 'Deleting project...' }
                );

                if (result.error) {
                    showNotification('Failed to delete project', 'error');
                } else {
                    showNotification(`Project "${projectName}" deleted successfully`, 'success');
                    loadProjects(); // Refresh the projects list
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                showNotification('Error deleting project', 'error');
            }
        }

        // Delete sheet with confirmation
        async function deleteSheet(sheetId, sheetName) {
            if (!confirm(`Are you sure you want to delete workflow "${sheetName}"?\n\nThis action cannot be undone and will delete all processes in this workflow.`)) {
                return;
            }

            try {
                const result = await window.FlowCraftErrorHandler.executeSupabaseRequest(
                    () => supabaseClient
                        .from('sheets')
                        .delete()
                        .eq('id', sheetId)
                        .eq('project_id', currentProject.id), // Ensure sheet belongs to current project
                    { loadingMessage: 'Deleting sheet...' }
                );

                if (result.error) {
                    showNotification('Failed to delete workflow', 'error');
                } else {
                    showNotification(`Workflow "${sheetName}" deleted successfully`, 'success');
                    loadSheets(); // Refresh the sheets list
                }
            } catch (error) {
                console.error('Error deleting workflow:', error);
                showNotification('Error deleting workflow', 'error');
            }
        }

    </script>
</body>
</html> 